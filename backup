<!DOCTYPE html>
<html class="dark" lang="en">
<head>
    <meta charset="utf-8">
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <title>Faiora - Digital Planner Prototype</title>
    <link rel="icon" href="logo.png">
    <link rel="manifest" href="manifest.json">
    
    <!-- Identity & Branding -->
    <meta name="description" content="Ignite your productivity with Faiora Digital Planner. Sync tasks and goals with Google.">
    <meta property="og:title" content="Faiora Digital Planner">
    <meta property="og:description" content="A fiery approach to digital planning.">
    <meta property="og:image" content="https://johnpaulinso.github.io/Faiora/logo.png">
    <meta property="og:url" content="https://johnpaulinso.github.io/Faiora/">
    
    <!-- Google Site Verification (Placeholder) -->
    <!-- Replace 'YOUR_VERIFICATION_CODE' with the code from Google Search Console -->
    <meta name="google-site-verification" content="googled6ec6ba0775bed83" />
    <!-- Libraries -->
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/history@5/umd/history.development.js"></script>
    <script src="https://unpkg.com/react-router@6.3.0/umd/react-router.development.js"></script>
    <script src="https://unpkg.com/react-router-dom@6.3.0/umd/react-router-dom.development.js"></script>
    <script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>
    
    <!-- Firebase SDK (Compat) -->
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>

    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Newsreader:ital,opsz,wght@0,6..72,200..800;1,6..72,200..800&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Montserrat:wght@400;500;600;700&display=swap" rel="stylesheet">

    <script id="tailwind-config">
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#f97316",
                        "primary-dark": "#ea580c",
                        "burnt-orange": "#7c2d12",
                        "charcoal": "#0a0a0a",
                        "cream-light": "#fff7ed",
                        "pastel-orange": "#ffedd5",
                        "pastel-peach": "#fed7aa",
                        "pastel-amber": "#fef3c7",
                        "pastel-yellow": "#fef9c3",
                        "gold-glow": "#fbbf24",
                    },
                    fontFamily: {
                        "display": ["Newsreader", "serif"],
                        "sans": ["Inter", "system-ui", "sans-serif"],
                        "montserrat": ["Montserrat", "sans-serif"]
                    },
                    borderRadius: { "DEFAULT": "0.25rem", "lg": "0.5rem", "xl": "0.75rem", "2xl": "1.5rem", "3xl": "2rem", "full": "9999px" },
                },
            },
        }
    </script>

    <style type="text/tailwindcss">
        html {
            font-size: 14.4px; /* 90% of default 16px */
            user-select: none;
            -webkit-user-select: none;
        }
        .dark-gradient-bg {
            background: linear-gradient(180deg, #7c2d12 0%, #111827 40%, #0a0a0a 100%);
            background-attachment: fixed;
        }
        .card-glow {
            box-shadow: 0 10px 30px -10px rgba(0, 0, 0, 0.5), 0 0 20px rgba(253, 186, 116, 0.1);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .card-glow:hover {
            transform: translateY(-4px) scale(1.02);
            box-shadow: 0 20px 40px -15px rgba(0, 0, 0, 0.6), 0 0 30px rgba(249, 115, 22, 0.2);
            z-index: 10;
        }
        .glow-orange {
            filter: drop-shadow(0 0 8px rgba(249, 115, 22, 0.6));
        }
        .glass-panel {
            background: rgba(255, 255, 255, 0.03);
            backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.08);
        }
        .task-creator-modal {
            background-color: #fcfaf7 !important; /* Match modal example.html */
            backdrop-filter: none !important;
            border: none !important;
            animation: modal-ease-in 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        @keyframes modal-ease-in {
            from { opacity: 0; transform: scale(0.95) translateY(10px); }
            to { opacity: 1; transform: scale(1) translateY(0); }
        }
        .modal-top-progress {
            height: 6px;
            width: 100%;
            background: #f1f5f9; /* slate-100 */
            overflow: hidden;
        }
        .modal-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #f97316 0%, #fbbf24 100%);
            transition: width 0.5s ease;
        }
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        .fab-shadow {
            box-shadow: 0 15px 35px -5px rgba(249, 115, 22, 0.4);
        }
        .sticky-note-1 { transform: rotate(-1.5deg); }
        .sticky-note-2 { transform: rotate(1.2deg); }
        .sticky-note-3 { transform: rotate(-0.8deg); }
        .sticky-note-4 { transform: rotate(2deg); }
        .sticky-note-5 { transform: rotate(-1.2deg); }
        .sticky-note-add { transform: rotate(0.5deg); }
        
        /* Loading Screen Specifics */
        .blur-overlay {
            backdrop-filter: blur(80px) saturate(120%);
            background: rgba(10, 10, 10, 0.7);
        }
        .flame-container {
            position: absolute;
            top: -18px; /* -20px * 0.9 */
            left: 0;
            right: 0;
            height: 36px; /* 40px * 0.9 */
            display: flex;
            justify-content: space-around;
            pointer-events: none;
        }
        .flame-tongue {
            width: 10.8px; /* 12px * 0.9 */
            height: 27px; /* 30px * 0.9 */
            background: linear-gradient(to top, rgba(249, 115, 22, 0.8), rgba(239, 68, 68, 0.4), transparent);
            border-radius: 50% 50% 20% 20%;
            filter: blur(5.4px); /* 6px * 0.9 */
            animation: flame-rise 2.5s infinite ease-in-out;
            transform-origin: bottom center;
        }
        @keyframes flame-rise {
            0%, 100% { transform: scaleY(1) translateY(0) scaleX(1); opacity: 0.4; }
            50% { transform: scaleY(1.5) translateY(-13.5px) scaleX(0.8); opacity: 0.7; }
        }
        .loading-arc {
            position: absolute;
            inset: 0;
            border-radius: 50%;
            border: 1.8px solid transparent; /* 2px * 0.9 */
            border-top: 1.8px solid #f97316;
            filter: drop-shadow(0 0 13.5px rgba(249, 115, 22, 0.8));
            animation: spin-smooth 3s linear infinite;
        }
        @keyframes spin-smooth {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Clock */
        /* Selection & Inputs */
        input, textarea, [contenteditable="true"], .block-input {
            -webkit-user-select: text !important;
            -ms-user-select: text !important;
            user-select: text !important;
        }
        
        .analog-clock {
            width: 270px; /* 300px * 0.9 */
            height: 270px; /* 300px * 0.9 */
            border-radius: 50%;
            border: 2px solid rgba(249, 115, 22, 0.3);
            position: relative;
            background: rgba(0, 0, 0, 0.2);
            box-shadow: 0 0 40px rgba(249, 115, 22, 0.1), inset 0 0 20px rgba(0, 0, 0, 0.5);
        }

        /* Page Transition Animations */
        .fire-wipe-overlay {
            position: fixed;
            left: 0;
            top: 0;
            width: 100vw;
            height: 100vh;
            z-index: 9999;
            pointer-events: none;
            display: flex;
            align-items: flex-end;
            will-change: transform;
        }

        .fire-wipe-active {
            animation: fire-wipe-sweep 1.8s cubic-bezier(0.4, 0, 0.2, 1) forwards !important;
        }

        .fire-bg-video {
            position: fixed;
            inset: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            z-index: -1;
            opacity: 0.25;
            mix-blend-mode: screen; /* Note: Can be expensive, but looks best */
            pointer-events: none;
            backface-visibility: hidden;
            transform: translateZ(0);
        }

        /* Floating Pill Toolbar - Repositioned to bottom center */
        .floating-toolbar-pill {
            display: flex;
            align-items: center;
            background: white;
            padding: 8px 16px;
            border-radius: 9999px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.12);
            gap: 12px;
            z-index: 60;
            border: 1px solid rgba(0,0,0,0.05);
            transition: all 0.3s cubic-bezier(0.19, 1, 0.22, 1);
            position: absolute;
            bottom: 24px;
            left: 50%;
            transform: translateX(-50%);
        }
        .toolbar-inner-divider {
            width: 1px;
            height: 20px;
            background: rgba(0,0,0,0.1);
            margin: 0 4px;
        }
        .toolbar-icon-btn {
            color: rgba(0,0,0,0.4);
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .toolbar-icon-btn:hover {
            color: rgba(0,0,0,0.8);
            transform: translateY(-1px);
        }
        .toolbar-icon-btn.active, .toolbar-icon-btn.highlighter {
            color: #f97316 !important;
            opacity: 1 !important;
        }

        /* Footer Refinement */
        .task-creator-footer {
            padding: 0.75rem 1rem;
            background: #fdfcfb !important;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-top: 1px solid #f1f5f9; /* border-slate-100 */
            min-height: 64px;
        }
        .footer-divider {
            width: 1px;
            height: 24px;
            background: #e2e8f0; /* slate-200 */
            margin: 0 4px;
        }
        .close-btn {
            padding: 0.625rem 1.5rem;
            color: #1e293b; /* slate-800 */
            border-radius: 0.5rem;
            font-family: inherit;
            font-weight: 500;
            font-size: 0.875rem;
            transition: background 0.2s;
        }
        .close-btn:hover {
            background: #f1f5f9; /* slate-100 */
        }
        .save-pill-btn {
            padding: 0.625rem 2rem;
            background: #f97316;
            color: white;
            border-radius: 9999px;
            font-family: inherit;
            font-weight: 700;
            font-size: 0.875rem;
            letter-spacing: 0.05em;
            text-transform: uppercase;
            box-shadow: 0 10px 20px rgba(249, 115, 22, 0.2);
            transition: all 0.2s;
        }
        .save-pill-btn:hover {
            background: #ea580c;
            transform: translateY(-1px);
            box-shadow: 0 12px 24px rgba(249, 115, 22, 0.3);
        }

        
        .block-checkbox {
            width: 18px;
            height: 18px;
            border: 2px solid #f97316;
            background: white;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-top: 6px;
        }
        .block-checkbox.checked {
            background: #f97316;
        }
        .block-checkbox.checked::after {
            content: 'check';
            font-family: 'Material Symbols Outlined';
            font-size: 14px;
            color: white;
            font-weight: bold;
        }

        .block-bullet {
            width: 5px;
            height: 5px;
            background: #94a3b8; /* slate-400 */
            border-radius: 50%;
            margin-top: 13px;
        }

        .footer-action-btn {
            padding: 10px;
            border-radius: 8px;
            color: rgba(0,0,0,0.6);
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .footer-action-btn:hover {
            background: rgba(0,0,0,0.04);
            color: rgba(0,0,0,0.9);
        }
        /* Save Button */
        .save-pill-btn {
            background: #f97316;
            color: white;
            padding: 8px 24px;
            border-radius: 9999px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            box-shadow: 0 4px 12px rgba(249, 115, 22, 0.2);
            transition: all 0.3s;
            font-size: 13px;
            font-family: 'Inter', sans-serif;
        }
        .save-pill-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 6px 16px rgba(249, 115, 22, 0.3);
            filter: brightness(1.05);
        }

        .fire-wipe-sprite {
            width: 100vw;
            height: 360px; /* 400px * 0.9 */
            background-image: url('fire-wipe-spritesheet.png');
            background-repeat: no-repeat;
            background-size: 100% 1800px; /* 2000px * 0.9 */
            animation: fire-wipe-sprites 0.5s steps(5) infinite;
            filter: drop-shadow(0 0 40px rgba(249, 115, 22, 0.9));
            opacity: 0.98;
            backface-visibility: hidden;
            transform: translateZ(0);
        }

        @keyframes fire-wipe-sweep {
            0% { transform: translate3d(0, 70vh, 0); opacity: 0; }
            15% { opacity: 1; }
            85% { opacity: 1; }
            100% { transform: translate3d(0, -100vh, 0); opacity: 0; }
        }

        /* Toast Notifications */
        .toast-container {
            position: fixed;
            bottom: 2rem;
            left: 50%;
            transform: translateX(-50%);
            z-index: 9999;
            pointer-events: none;
        }
        .toast-pill {
            background: #111827;
            color: #fff7ed;
            padding: 10px 24px;
            border-radius: 9999px;
            font-size: 0.85rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 12px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.4);
            animation: toast-in-out 3s ease forwards;
            border: 1px solid rgba(255,255,255,0.1);
        }
        @keyframes toast-in-out {
            0% { opacity: 0; transform: translateY(20px); }
            10% { opacity: 1; transform: translateY(0); }
            90% { opacity: 1; transform: translateY(0); }
            100% { opacity: 0; transform: translateY(-20px); }
        }

        @keyframes fire-wipe-sprites {
            to { background-position: 0 -1800px; } /* 2000px * 0.9 */
        }

        @media (max-width: 768px) {
            .fire-wipe-sprite {
                background-size: 450% 1800px !important; 
                background-position: 50% 0;
            }
            @keyframes fire-wipe-sprites {
                to { background-position: 50% -1800px; }
            }
        }

        .dissolve-layer {
            transition: opacity 0.3s ease-in-out, filter 0.3s ease-in-out;
        }

        .dissolve-out {
            opacity: 0;
            filter: blur(2px);
        }

        .dissolve-in {
            opacity: 1;
            filter: blur(0);
            animation: content-fade-in 0.4s ease-out forwards;
        }

        @keyframes content-fade-in {
            from { 
                opacity: 0;
                transform: translate3d(0, 10px, 0);
            }
            to { 
                opacity: 1;
                transform: translate3d(0, 0, 0);
            }
        }

        /* Liquid Progress Bar */
        .liquid-progress {
            position: relative;
            background: rgba(0, 0, 0, 0.4);
            overflow: visible; /* Allow handle to glow outside */
            border-radius: 0; /* Keep it flush for now or subtle round */
            box-shadow: inset 0 2px 10px rgba(0,0,0,0.5);
            height: 32px !important; /* Larger hit area */
            border-bottom: 1px solid rgba(249, 115, 22, 0.2);
        }
        .liquid-fill {
            height: 100%;
            background: linear-gradient(90deg, #7c2d12, #f97316, #fed7aa);
            background-size: 200% 100%;
            position: relative;
            transition: width 0.8s cubic-bezier(0.34, 1.56, 0.64, 1);
            animation: move-gradient 3s linear infinite;
        }
        .liquid-glow-handle {
            position: absolute;
            right: -12px;
            top: 50%;
            transform: translateY(-50%);
            width: 24px;
            height: 24px;
            background: #fff;
            border-radius: 50%;
            box-shadow: 0 0 20px #f97316, 0 0 40px #f97316;
            z-index: 10;
            pointer-events: none;
            border: 2px solid #ea580c;
        }
        
        /* Floating Selection Menu */
        .selection-menu {
            position: fixed;
            z-index: 500;
            display: flex;
            gap: 4px;
            padding: 6px;
            background: #1a1a1a;
            border: 1px solid rgba(249, 115, 22, 0.3);
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5), 0 0 20px rgba(249, 115, 22, 0.1);
            transform: translate(-50%, -100%);
            margin-top: -12px;
            animation: pop-up 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        
        @keyframes pop-up {
            from { opacity: 0; transform: translate(-50%, -80%) scale(0.9); }
            to { opacity: 1; transform: translate(-50%, -100%) scale(1); }
        }
        
        .selection-menu-btn {
            padding: 6px;
            border-radius: 8px;
            color: rgba(255, 255, 255, 0.6);
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .selection-menu-btn:hover {
            background: rgba(249, 115, 22, 0.15);
            color: #f97316;
        }
        @keyframes move-gradient {
            0% { background-position: 0% 50%; }
            100% { background-position: 200% 50%; }
        }
        
        .block-input:focus {
            outline: none;
        }
        .block-input::placeholder {
            color: rgba(255, 247, 237, 0.1);
        }

        /* Note Themes (Solid Colors) */
        .theme-amber { background-color: #fef3c7 !important; color: #451a03 !important; backdrop-filter: none !important; }
        .theme-orange { background-color: #fff7ed !important; color: #431407 !important; backdrop-filter: none !important; }
        .theme-peach { background-color: #fff7ed !important; color: #431407 !important; backdrop-filter: none !important; }
        .theme-yellow { background-color: #ffffdd !important; color: #422006 !important; backdrop-filter: none !important; }
        .theme-green { background-color: #e8f5e9 !important; color: #1b5e20 !important; }
        .theme-blue { background-color: #e3f2fd !important; color: #0d47a1 !important; }
        .theme-purple { background-color: #f3e5f5 !important; color: #4a148c !important; }
        .theme-pink { background-color: #fce4ec !important; color: #880e4f !important; }
        
        .glass-panel[class*='theme-'] {
            background: unset !important;
            backdrop-filter: none !important;
            border: none !important;
            box-shadow: 0 40px 100px rgba(0,0,0,0.3) !important;
        }

        .theme-amber .block-input, .theme-orange .block-input, .theme-peach .block-input, 
        .theme-yellow .block-input, .theme-green .block-input, .theme-blue .block-input,
        .theme-purple .block-input, .theme-pink .block-input {
            color: inherit !important;
            font-family: 'Inter', sans-serif !important;
            user-select: text !important;
        }

        .block-input.h1 { font-size: 2.25rem; font-weight: 800; line-height: 1.2; letter-spacing: -0.02em; }
        .block-input.h2 { font-size: 1.75rem; font-weight: 700; line-height: 1.3; }
        .block-input { font-size: 1.2rem !important; }
        
        .theme-amber input::placeholder, .theme-orange input::placeholder, .theme-peach input::placeholder,
        .theme-yellow input::placeholder, .theme-green input::placeholder, .theme-blue input::placeholder,
        .theme-purple input::placeholder, .theme-pink input::placeholder {
            color: rgba(0,0,0,0.1) !important;
        }
        .theme-amber .block-input::placeholder, .theme-orange .block-input::placeholder, .theme-peach .block-input::placeholder,
        .theme-yellow .block-input::placeholder, .theme-green .block-input::placeholder, .theme-blue .block-input::placeholder,
        .task-creator-modal ::selection {
            background: rgba(148, 163, 184, 0.4) !important;
            color: inherit !important;
        }

        /* Content Editable Area Styling */
        .note-editor-area {
            outline: none;
            min-height: 200px;
            font-family: 'Inter', sans-serif;
            color: #334155;
            line-height: 1.6;
            font-size: 1.2rem;
            padding: 0 1rem; /* Base horizontal alignment */
        }

        .note-editor-area:empty:before {
            content: attr(data-placeholder);
            color: #94a3b8;
            opacity: 0.5;
            pointer-events: none;
            display: block;
        }

        .note-editor-area ul {
            list-style-type: disc !important;
            padding-left: 5rem;
            margin: 0.8rem 0;
        }

        .note-editor-area ol {
            list-style-type: decimal !important;
            padding-left: 5rem;
            margin: 0.8rem 0;
        }

        .note-editor-area li {
            margin-bottom: 0.4rem;
            padding-left: 0.2rem;
        }

        .note-editor-area ul li::marker, .note-editor-area ol li::marker {
            color: #f97316;
            font-weight: bold;
        }

        /* Checklist Support */
        .note-editor-area .checklist-item {
            list-style-type: none !important;
            display: flex;
            align-items: flex-start;
            gap: 16px;
            padding-left: 4rem;
            margin-bottom: 0.4rem; /* Reduced margin */
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .note-editor-area .checklist-item.checked span:not(.checklist-checkbox) {
            text-decoration: line-through !important;
            opacity: 0.55 !important;
            color: #64748b !important;
        }

        .note-editor-area .checklist-item.checked {
            opacity: 1 !important; /* Keep container opacity high */
        }

        .note-editor-area .checklist-checkbox {
            width: 22px;
            height: 22px;
            border: 2px solid #f97316;
            background: white;
            border-radius: 6px;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            margin-top: 4px;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .note-editor-area .checklist-checkbox:hover {
            background: #fff7ed;
            transform: scale(1.1);
        }

        .note-editor-area h1 {
            font-size: 1.8rem !important;
            font-weight: 800 !important;
            color: #1e293b;
            margin: 0.5rem 0;
            display: block;
        }

        .note-editor-area h2 {
            font-size: 1.4rem !important;
            font-weight: 700 !important;
            color: #334155;
            margin: 0.4rem 0;
            display: block;
        }

        .highlight-option {
            width: 24px;
            height: 24px;
            border-radius: 6px;
            cursor: pointer;
            border: 1px solid rgba(0,0,0,0.1);
            transition: all 0.2s;
        }

        .highlight-option:hover {
            transform: scale(1.2);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .note-editor-area .checklist-item.checked .checklist-checkbox::after {
            content: 'check';
            font-family: 'Material Symbols Outlined';
            font-size: 14px;
            color: white;
            font-weight: 800;
        }

        .note-editor-area .checklist-item.checked .checklist-checkbox {
            background: #f97316;
            border-color: #f97316;
            box-shadow: 0 0 10px rgba(249, 115, 22, 0.3);
        }

        /* Image Resizing Styles */
        .resizable-image-container {
            position: relative;
            display: inline-block;
            margin: 1.5rem 0;
            max-width: 100%;
            z-index: 50;
            pointer-events: auto !important;
            touch-action: none; /* Disable browser gestures while interacting */
        }
        .resizable-image-container.selected {
            z-index: 60 !important;
        }
        .resizable-image {
            display: block;
            border-radius: 12px;
            cursor: pointer;
            transition: outline 0.2s, box-shadow 0.2s, transform 0.2s;
            max-width: 100%;
            pointer-events: auto !important;
        }
        .resizable-image.selected {
            outline: 5px solid #f97316 !important;
            outline-offset: 3px !important;
            box-shadow: 0 0 40px rgba(249, 115, 22, 0.8), 0 0 80px rgba(249, 115, 22, 0.3) !important;
            transform: scale(1.02);
            position: relative;
        }
        .resize-handle {
            position: absolute;
            width: 20px; /* Bigger for touch */
            height: 20px;
            background: #f97316 !important;
            border: 2px solid white !important;
            border-radius: 50%;
            z-index: 100 !important;
            display: none;
            box-shadow: 0 4px 15px rgba(0,0,0,0.4);
            transition: transform 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            pointer-events: auto !important;
        }
        .resize-handle:hover {
            transform: scale(1.4);
            background: #ea580c !important;
        }
        .resizable-image-container.selected .resize-handle {
            display: block !important;
        }
        .resize-handle.br { bottom: -10px; right: -10px; cursor: se-resize; }
        
        /* Cropping Styles */
        .crop-controls {
            position: absolute;
            top: -50px;
            left: 50%;
            transform: translateX(-50%);
            display: none;
            gap: 8px;
            z-index: 150;
            background: white;
            padding: 4px 8px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            border: 1px solid rgba(0,0,0,0.05);
        }
        .resizable-image-container.selected .crop-controls {
            display: flex;
        }
        .crop-btn {
            padding: 6px 12px;
            border-radius: 8px;
            font-size: 11px;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .crop-btn.primary {
            background: #f97316;
            color: white;
        }
        .crop-btn.secondary {
            background: #f1f5f9;
            color: #64748b;
        }
        .crop-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .cropping-active .resizable-image {
            opacity: 0.5;
        }
        .cropping-active .crop-mask {
            position: absolute;
            border: 2px solid #f97316;
            box-shadow: 0 0 0 9999px rgba(0,0,0,0.5);
            z-index: 80;
            pointer-events: none;
            box-sizing: border-box;
        }
        /* Edge handles for cropping */
        .crop-handle {
            position: absolute;
            background: #f97316;
            z-index: 110;
            display: none;
        }
        .cropping-active .crop-handle { display: block; }
        .cropping-active .resize-handle { display: none !important; }

        .crop-handle.edge-t { top: -2px; left: 20px; right: 20px; height: 5px; cursor: n-resize; }
        .crop-handle.edge-b { bottom: -2px; left: 20px; right: 20px; height: 5px; cursor: s-resize; }
        .crop-handle.edge-l { left: -2px; top: 20px; bottom: 20px; width: 5px; cursor: w-resize; }
        .crop-handle.edge-r { right: -2px; top: 20px; bottom: 20px; width: 5px; cursor: e-resize; }
        
        body.resizing-active { cursor: nwse-resize !important; user-select: none !important; }

        /* Dropdown & Search Styles */
        .more-menu-dropdown {
            position: absolute;
            bottom: calc(100% + 12px);
            right: 0;
            background: white;
            border-radius: 1.5rem;
            box-shadow: 0 20px 50px rgba(0,0,0,0.15);
            border: 1px solid rgba(0,0,0,0.05);
            width: 200px;
            padding: 8px;
            z-index: 100;
            display: flex;
            flex-direction: column;
            gap: 2px;
        }
        .menu-item {
            width: 100%;
            padding: 10px 16px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            gap: 12px;
            color: #475569;
            font-size: 0.9rem;
            font-weight: 500;
            transition: all 0.2s;
            font-family: 'Montserrat', sans-serif;
        }
        .menu-item:hover {
            background: #f8fafc;
            color: #f97316;
        }
        .menu-item.danger {
            color: #ef4444;
        }
        .menu-item.danger:hover {
            background: #fef2f2;
        }
        .search-bar-container {
            padding: 8px 12px;
            border-bottom: 1px solid #f1f5f9;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .search-input {
            width: 100%;
            border: none;
            outline: none;
            font-size: 0.85rem;
            color: #1e293b;
        }

    </style>
<style>
    body {
      min-height: max(795px, 100dvh); /* 884px * 0.9 */
    }
  </style>
  </head>
<body class="dark-gradient-bg font-display text-slate-100 min-h-screen selection:bg-primary/30 overflow-hidden">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo, useCallback } = React;
        const { createRoot } = ReactDOM;
        const { MemoryRouter, Routes, Route, Link, useNavigate, useLocation } = ReactRouterDOM;

        // --- Firebase Initialization ---
        const firebaseConfig = {
            apiKey: "AIzaSyDktbyVgI7AAwaY2u-KsWBRwLZawy0949s",
            authDomain: "faiora-24f4a.firebaseapp.com",
            projectId: "faiora-24f4a",
            storageBucket: "faiora-24f4a.firebasestorage.app",
            messagingSenderId: "752265363994",
            appId: "1:752265363994:web:78795bfad67d2d541e07a3",
            measurementId: "G-B0DWSL1JMV"
        };
        
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        
        // Enable offline persistence for smoother, instant loading
        db.enablePersistence().catch(err => {
            if (err.code === 'failed-precondition') {
                console.warn("Persistence failed: multiple tabs open");
            } else if (err.code === 'unimplemented') {
                console.warn("Persistence not supported by browser");
            }
        });

        const googleProvider = new firebase.auth.GoogleAuthProvider();
        
        // --- Shared Components ---

        const Sidebar = () => {
            const location = useLocation();
            const isActive = (path) => location.pathname === path;

            return (
                <aside className="hidden md:flex w-24 border-r border-white/5 flex-col items-center py-10 gap-10 bg-black/40 backdrop-blur-xl z-20">
                    <div className="text-primary mb-6">
                        <span className="material-symbols-outlined text-4xl font-light glow-orange" style={{fontVariationSettings: '"FILL" 1'}}>local_fire_department</span>
                    </div>
                    <nav className="flex flex-col gap-8">
                        <Link to="/" className={`group relative p-3 rounded-2xl transition-all duration-300 ${isActive('/') ? 'bg-primary/10 text-primary' : 'text-slate-500 hover:text-primary'}`} title="Tasks">
                            <span className="material-symbols-outlined text-3xl">check_box</span>
                        </Link>
                        <Link to="/notes" className={`group relative p-3 rounded-2xl transition-all duration-300 ${isActive('/notes') ? 'bg-primary/10 text-primary' : 'text-slate-500 hover:text-primary'}`} title="Notes">
                            <span className="material-symbols-outlined text-3xl">grid_view</span>
                        </Link>
                        <Link to="/calendar" className={`group relative p-3 rounded-2xl transition-all duration-300 ${isActive('/calendar') ? 'bg-primary/10 text-primary' : 'text-slate-500 hover:text-primary'}`} title="Calendar">
                            <span className="material-symbols-outlined text-3xl">calendar_month</span>
                        </Link>
                        <Link to="/stats" className={`group relative p-3 rounded-2xl transition-all duration-300 ${isActive('/stats') ? 'bg-primary/10 text-primary' : 'text-slate-500 hover:text-primary'}`} title="Graph">
                            <span className="material-symbols-outlined text-3xl">leaderboard</span>
                        </Link>
                        <Link to="/streak" className={`group relative p-3 rounded-2xl transition-all duration-300 ${isActive('/streak') ? 'bg-primary/10 text-primary glow-orange' : 'text-slate-500 hover:text-primary'}`} title="Flame">
                            <span className="material-symbols-outlined text-3xl" style={isActive('/streak') ? {fontVariationSettings: '"FILL" 1'} : {}}>local_fire_department</span>
                        </Link>
                        <Link to="/clock" className={`group relative p-3 rounded-2xl transition-all duration-300 ${isActive('/clock') ? 'bg-primary/10 text-primary' : 'text-slate-500 hover:text-primary'}`} title="Clock">
                            <span className="material-symbols-outlined text-3xl">history</span>
                        </Link>
                    </nav>
                </aside>
            );
        };

        const MobileNav = () => {
            const location = useLocation();
            const isActive = (path) => location.pathname === path;
            
            return (
                <nav className="fixed bottom-0 left-0 right-0 bg-black/80 backdrop-blur-2xl border-t border-white/5 flex justify-around items-center py-5 md:hidden z-50">
                    <Link to="/" className={isActive('/') ? 'text-primary' : 'text-slate-500'}>
                        <span className="material-symbols-outlined text-3xl">check_box</span>
                    </Link>
                    <Link to="/notes" className={isActive('/notes') ? 'text-primary' : 'text-slate-500'}>
                        <span className="material-symbols-outlined text-3xl">grid_view</span>
                    </Link>
                    <Link to="/streak" className={isActive('/streak') ? 'text-primary glow-orange' : 'text-slate-500'}>
                        <span className="material-symbols-outlined text-3xl" style={{fontVariationSettings: isActive('/streak') ? '"FILL" 1' : ''}}>local_fire_department</span>
                    </Link>
                    <Link to="/stats" className={isActive('/stats') ? 'text-primary' : 'text-slate-500'}>
                        <span className="material-symbols-outlined text-3xl">leaderboard</span>
                    </Link>
                    <Link to="/clock" className={isActive('/clock') ? 'text-primary' : 'text-slate-500'}>
                        <span className="material-symbols-outlined text-3xl">history</span>
                    </Link>
                </nav>
            );
        };

        const Layout = ({ children, onOpenCreator }) => {
            return (
                <div className="flex h-screen overflow-hidden">
                    <Sidebar />
                    <main className="flex-1 flex flex-col overflow-y-auto no-scrollbar relative">
                        {children}
                        <button 
                            onClick={onOpenCreator}
                            className="fixed bottom-12 right-12 w-20 h-20 bg-primary hover:bg-primary-dark text-white rounded-full flex items-center justify-center fab-shadow transition-all duration-300 hover:scale-110 active:scale-95 z-40 group"
                        >
                            <span className="material-symbols-outlined text-4xl group-hover:rotate-90 transition-transform duration-300">add</span>
                        </button>
                    </main>
                    <MobileNav />
                </div>
            );
        };

        const UserMenu = ({ user }) => {
            const [isOpen, setIsOpen] = useState(false);
            const menuRef = useRef();

            useEffect(() => {
                const handleClickOutside = (event) => {
                    if (menuRef.current && !menuRef.current.contains(event.target)) {
                        setIsOpen(false);
                    }
                };
                document.addEventListener("mousedown", handleClickOutside);
                return () => document.removeEventListener("mousedown", handleClickOutside);
            }, []);

            const handleLogout = () => {
                auth.signOut();
                localStorage.removeItem('faiora_logged_in');
            };

            const handleLogin = () => {
                auth.signInWithPopup(googleProvider);
            };

            if (!user) {
                return (
                    <button 
                        onClick={handleLogin}
                        className="flex items-center gap-2 px-4 py-2 bg-white/5 hover:bg-white/10 border border-white/10 rounded-full text-xs font-bold transition-all text-cream-light/60 hover:text-primary active:scale-95"
                    >
                        <span className="material-symbols-outlined text-lg">login</span>
                        LOGIN
                    </button>
                );
            }

            return (
                <div className="relative" ref={menuRef}>
                    <button 
                        onClick={() => setIsOpen(!isOpen)}
                        className="w-10 h-10 md:w-12 md:h-12 rounded-full overflow-hidden border border-white/10 ring-4 ring-black/20 hover:ring-primary/40 transition-all duration-300"
                    >
                        <img 
                            alt={user.displayName || "User"} 
                            className="w-full h-full object-cover bg-primary/20" 
                            src={user.photoURL || "https://www.gravatar.com/avatar/00000000000000000000000000000000?d=mp&f=y"}
                        />
                    </button>

                    {isOpen && (
                        <div className="absolute right-0 mt-4 w-64 bg-slate-900 border border-white/20 rounded-3xl p-2 shadow-[0_25px_60px_rgba(0,0,0,0.8)] z-[250] animate-in fade-in slide-in-from-top-2 duration-200 overflow-hidden">
                            <div className="p-4 border-b border-white/5 mb-2">
                                <p className="text-white font-bold truncate">{user.displayName}</p>
                                <p className="text-white/40 text-xs truncate">{user.email}</p>
                            </div>
                            <button className="flex items-center gap-3 w-full p-3 hover:bg-white/10 rounded-2xl text-white/70 hover:text-primary transition-all text-sm group">
                                <span className="material-symbols-outlined text-xl group-hover:scale-110 transition-transform">person</span>
                                Profile
                            </button>
                            <button className="flex items-center gap-3 w-full p-3 hover:bg-white/10 rounded-2xl text-white/70 hover:text-primary transition-all text-sm group">
                                <span className="material-symbols-outlined text-xl group-hover:scale-110 transition-transform">settings</span>
                                Settings
                            </button>
                            <div className="h-px bg-white/5 my-2"></div>
                            <button 
                                onClick={handleLogout}
                                className="flex items-center gap-3 w-full p-3 hover:bg-red-500/20 rounded-2xl text-red-400 hover:text-red-300 transition-all text-sm group"
                            >
                                <span className="material-symbols-outlined text-xl group-hover:scale-110 transition-transform">logout</span>
                                Logout
                            </button>
                        </div>
                    )}
                </div>
            );
        };

        const Header = ({ title = "Faiora", subtitle = "Digital Planner", user }) => (
            <React.Fragment>
                {/* Mobile Sticky Header */}
                <header className="md:hidden sticky top-0 left-0 right-0 z-[200] bg-[#2a0e06]/90 backdrop-blur-xl border-b border-white/5 px-4 py-3 flex items-center justify-between gap-3">
                    <button className="w-10 h-10 rounded-full bg-[#3d1a0f] border border-white/10 flex items-center justify-center text-primary glow-orange active:scale-95 transition-all">
                        <span className="material-symbols-outlined text-2xl" style={{fontVariationSettings: '"FILL" 1'}}>local_fire_department</span>
                    </button>
                    
                    <div className="flex-1 relative flex items-center group">
                        <span className="material-symbols-outlined absolute left-4 text-white/40 text-xl group-focus-within:text-primary transition-colors">search</span>
                        <input 
                            type="text" 
                            placeholder="Search Fiora"
                            className="w-full bg-white/5 border border-white/10 rounded-full py-2.5 pl-11 pr-4 text-sm text-white placeholder:text-white/20 focus:outline-none focus:ring-2 focus:ring-primary/40 focus:bg-white/10 transition-all font-display italic"
                        />
                    </div>

                    <div className="shrink-0">
                        <UserMenu user={user} />
                    </div>
                </header>

                {/* PC/Branded Header */}
                <header className="relative z-[150] mb-12 md:mb-20 px-6 md:px-0 mt-8 md:mt-0">
                    <div className="flex justify-between items-start gap-8">
                        {/* Desktop: Logo & Title Group */}
                        <div className="flex flex-col">
                            <h1 className="text-5xl md:text-8xl font-bold tracking-tighter text-cream-light italic leading-none drop-shadow-2xl">
                                {title}
                            </h1>
                            <p className="text-primary/70 text-[10px] md:text-sm mt-1 md:mt-2 uppercase tracking-[0.3em] md:tracking-[0.5em] font-sans font-bold opacity-90">
                                {subtitle}
                            </p>
                        </div>

                        {/* Desktop: Actions Group (Search & Profile) */}
                        <div className="hidden md:flex items-center gap-4 md:gap-8 pt-2">
                            {/* Search Icon */}
                            <button className="text-cream-light/40 hover:text-cream-light hover:bg-white/10 transition-all p-3 rounded-full focus:outline-none focus:ring-4 focus:ring-primary/20 group">
                                <span className="material-symbols-outlined text-2xl md:text-3xl group-hover:scale-110 transition-transform">search</span>
                            </button>

                            <div className="scale-90 md:scale-110 origin-right">
                                <UserMenu user={user} />
                            </div>
                        </div>
                    </div>
                </header>
            </React.Fragment>
        );

        const TaskCreator = ({ onClose, user, editingNote, activeCollection, onUpdateNote, onDeleteNote, showToast }) => {
            const noteId = useMemo(() => editingNote ? editingNote.id : 'note_' + Date.now(), [editingNote]);
            const [title, setTitle] = useState(editingNote ? editingNote.title || '' : '');
            const [content, setContent] = useState(editingNote ? editingNote.content || '' : '');
            const [progress, setProgress] = useState(editingNote ? editingNote.progress || 0 : 0);
            const [history, setHistory] = useState([]);
            const [historyIndex, setHistoryIndex] = useState(-1);
            const [showConfirm, setShowConfirm] = useState({ show: false, title: '', message: '', onConfirm: null, type: 'danger' });
            const [showDeleteConfirm, setShowDeleteConfirm] = useState(false);
            const [isPinned, setIsPinned] = useState(editingNote ? !!editingNote.isPinned : false);
            const [noteTheme, setNoteTheme] = useState(editingNote ? editingNote.noteTheme || 'peach' : 'peach');
            const [activePopup, setActivePopup] = useState(null);
            const [hasChanges, setHasChanges] = useState(false);
            const [isSaving, setIsSaving] = useState(false);
            const [reminderDate, setReminderDate] = useState(editingNote ? editingNote.reminderDate || '' : '');
            const [showCustomReminder, setShowCustomReminder] = useState(false);
            const [noteIcon, setNoteIcon] = useState(editingNote ? editingNote.noteIcon || '' : '');
            const [searchTerm, setSearchTerm] = useState('');
            const [labels, setLabels] = useState(editingNote ? editingNote.labels || [] : []);
            const [newLabelText, setNewLabelText] = useState('');
            const [versionHistory, setVersionHistory] = useState([]);
            const [selectedImage, setSelectedImage] = useState(null);
            const [isCropping, setIsCropping] = useState(false);
            const [cropRect, setCropRect] = useState(null);
            const [isClosing, setIsClosing] = useState(false);
            const fileInputRef = useRef(null);
            const editorRef = useRef(null);
            const initialContent = useMemo(() => editingNote ? editingNote.content || '' : '', [editingNote]);

            const icons = [
                'star', 'favorite', 'home', 'work', 'rocket', 'lightbulb', 'eco', 'auto_stories', 
                'fitness_center', 'restaurant', 'pets', 'explore', 'shopping_cart', 'celebration', 
                'terminal', 'brush', 'psychology', 'monitoring', 'diversity_3', 'sports_esports',
                'volunteer_activism', 'public', 'castle', 'luggage', 'shopping_bag', 'wallet',
                'medication', 'spa', 'comedy_mask', 'theater_comedy', 'music_note', 'piano',
                'palette', 'architecture', 'biotech', 'science', 'vape_free', 'podcasts'
            ];
            
            const filteredIcons = icons.filter(icon => icon.toLowerCase().includes(searchTerm.toLowerCase()));

            useEffect(() => {
                // Global mouse/key handlers can be added here if needed for the single area
            }, []);

            useEffect(() => {
                if (editingNote) return; // Don't load from single doc if we have an editing note
                if (!user || !activeCollection) return;
                // Legacy single-doc load for backward compat (only for new notes)
                db.collection(activeCollection).doc(user.uid).get().then(function(doc) {
                    if (doc.exists && !editingNote) {
                        // Don't overwrite if we have editingNote
                    }
                })["catch"](function(e) {
                    console.error("Error loading tasks", e);
                });
            }, [user, editingNote, activeCollection]);

            const saveToFirestore = (updatedNote) => {
                if (!user) return;

                // 1. Optimistically update local state via prop handler
                const newNote = {
                    ...updatedNote,
                    id: noteId,
                    updatedAt: new Date().toISOString()
                };
                
                if (onUpdateNote) {
                    onUpdateNote(newNote);
                }

                // 2. Background sync to Firestore
                if (activeCollection) {
                    db.collection(activeCollection).doc(user.uid).update({
                        [`notes.${noteId}`]: {
                            ...newNote,
                            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                        }
                    }).catch(e => {
                        if (e.code === 'not-found') {
                            // Document doesn't exist yet, use .set()
                            db.collection(activeCollection).doc(user.uid).set({
                                notes: {
                                    [noteId]: {
                                        ...newNote,
                                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                                    }
                                }
                            }, { merge: true });
                        } else {
                            console.warn("Silent background save failed:", e.message);
                        }
                    });
                }
            };

            useEffect(() => {
                const handleGlobalKeyDown = (e) => {
                    // Ctrl+Z: Undo
                    if ((e.ctrlKey || e.metaKey) && e.key === 'z') {
                        e.preventDefault();
                        undo();
                    }
                    // Ctrl+Y: Redo
                    if ((e.ctrlKey || e.metaKey) && e.key === 'y') {
                        e.preventDefault();
                        redo();
                    }
                };
                window.addEventListener('keydown', handleGlobalKeyDown);
                return () => window.removeEventListener('keydown', handleGlobalKeyDown);
            }, []);

            // Debounced Auto-Save
            useEffect(() => {
                if (!user || !hasChanges) return;
                const timer = setTimeout(() => {
                    const html = editorRef.current ? editorRef.current.innerHTML : content;
                    saveToFirestore({ title, content: html, progress, isPinned, noteTheme, noteIcon, labels, reminderDate });
                    setHasChanges(false);
                    if (showToast) showToast("Changes Saved");
                }, 1500); // 1.5s debounce for smoother typing
                return () => clearTimeout(timer);
            }, [title, content, progress, isPinned, noteTheme, noteIcon, labels, reminderDate, user, hasChanges, saveToFirestore, showToast]);

            // Set editor content on initial load or note change
            useEffect(() => {
                if (editorRef.current && initialContent !== undefined) {
                    editorRef.current.innerHTML = initialContent;
                }
            }, [initialContent]);

            const handleDeleteNote = () => {
                setShowDeleteConfirm(true);
            };

            const confirmDeleteNote = () => {
                setShowDeleteConfirm(false);
                if (!user) return;

                // 1. Optimistic removal via prop handler
                if (onDeleteNote) {
                    onDeleteNote(noteId);
                }

                // 2. Close modal immediately
                setIsClosing(true);
                setTimeout(() => onClose(), 180);

                // 3. Background background deletion
                if (activeCollection) {
                    db.collection(activeCollection).doc(user.uid).update({
                        [`notes.${noteId}`]: firebase.firestore.FieldValue.delete()
                    })
                    .catch(function(e) {
                        if (e.code !== 'not-found') {
                            console.warn("Firestore delete failed (silent):", e.message);
                        }
                    });
                }
            };

            const triggerClose = () => {
                setIsClosing(true);
                setTimeout(() => onClose(), 180);
            };

            const handleClose = () => {
                const html = editorRef.current ? editorRef.current.innerHTML : content;
                const isBlank = !title.trim() && (!html || html === '<br>' || html === '<div><br></div>' || html.trim() === '');
                
                if (isBlank && !editingNote) {
                    triggerClose();
                    return;
                }

                if (hasChanges) {
                    // Auto-save on exit
                    saveToFirestore({ title, content: html, progress, isPinned, noteTheme, noteIcon, labels, reminderDate });
                    if (showToast) showToast("Changes Saved");
                }
                triggerClose();
            };

            const handleProgressClick = (e) => {
                const rect = e.currentTarget.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const percent = Math.round((x / rect.width) * 10) * 10;
                setProgress(Math.max(0, Math.min(100, percent)));
                saveState();
            };

            const themes = [
                { id: 'glass', color: 'rgba(255,255,255,0.05)', themeClass: '' },
                { id: 'peach', color: '#ffedd5', themeClass: 'theme-peach' },
                { id: 'amber', color: '#fef3c7', themeClass: 'theme-amber' },
                { id: 'orange', color: '#ffedd5', themeClass: 'theme-orange' },
                { id: 'yellow', color: '#fef9c3', themeClass: 'theme-yellow' },
                { id: 'sage', color: '#ecfdf5', themeClass: 'theme-sage' },
                { id: 'sky', color: '#e0f2fe', themeClass: 'theme-sky' },
                { id: 'lavender', color: '#eef2ff', themeClass: 'theme-lavender' },
                { id: 'rose', color: '#fff1f2', themeClass: 'theme-rose' },
                { id: 'slate', color: '#f1f5f9', themeClass: 'theme-slate' },
                { id: 'teal', color: '#f0fdfa', themeClass: 'theme-teal' },
                { id: 'indigo', color: '#f5f3ff', themeClass: 'theme-indigo' }
            ];


            const undo = () => {
                if (historyIndex > 0) {
                    const prev = history[historyIndex - 1];
                    setTitle(prev.title);
                    if (editorRef.current) editorRef.current.innerHTML = prev.content;
                    setContent(prev.content);
                    setProgress(prev.progress);
                    setIsPinned(prev.isPinned);
                    setNoteTheme(prev.noteTheme || 'glass');
                    setReminderDate(prev.reminderDate || '');
                    setHistoryIndex(historyIndex - 1);
                }
            };

            const redo = () => {
                if (historyIndex < history.length - 1) {
                    const next = history[historyIndex + 1];
                    setTitle(next.title);
                    if (editorRef.current) editorRef.current.innerHTML = next.content;
                    setContent(next.content);
                    setProgress(next.progress);
                    setIsPinned(next.isPinned);
                    setNoteTheme(next.noteTheme || 'glass');
                    setReminderDate(next.reminderDate || '');
                    setHistoryIndex(historyIndex + 1);
                }
            };

            const saveState = useCallback(() => {
                const html = editorRef.current ? editorRef.current.innerHTML : content;
                const currentState = { title, content: html, progress, isPinned, noteTheme, noteIcon, labels, reminderDate };
                const newHistory = history.slice(0, historyIndex + 1);
                newHistory.push(currentState);
                setHistory(newHistory.slice(-30));
                setHistoryIndex(Math.min(newHistory.length - 1, 29));
                
                saveToFirestore(currentState);
                setHasChanges(false);
            }, [title, content, progress, isPinned, noteTheme, noteIcon, labels, reminderDate, history, historyIndex, saveToFirestore]);

            const convertActiveBlock = (type) => {
                const selection = window.getSelection();
                if (!selection.rangeCount) return;
                let range = selection.getRangeAt(0);
                
                const getBlockParent = (node) => {
                    if (!node) return null;
                    let curr = node;
                    if (curr.nodeType === 3) curr = curr.parentElement;
                    while (curr && curr !== editorRef.current) {
                        if (['LI', 'DIV', 'P', 'BLOCKQUOTE', 'H1', 'H2', 'H3'].includes(curr.nodeName)) return curr;
                        curr = curr.parentNode;
                    }
                    return null;
                };

                // Helper to find all checklist items in current selection
                const getSelectedCheckItems = () => {
                    if (!editorRef.current) return [];
                    const items = [];
                    const allItems = editorRef.current.querySelectorAll('.checklist-item');
                    allItems.forEach(item => {
                        if (selection.containsNode(item, true)) {
                            items.push(item);
                        }
                    });
                    return items;
                };

                const selectedCheckItems = getSelectedCheckItems();
                const isBulletActive = document.queryCommandState('insertUnorderedList');
                const isNumberActive = document.queryCommandState('insertOrderedList');

                // Direction: FROM Checklist TO Bullets/Numbers/Normal/H1/H2
                if (type !== 'todo' && selectedCheckItems.length > 0) {
                    const newDivs = [];
                    selectedCheckItems.forEach(item => {
                        const content = item.querySelector('span:not(.checklist-checkbox)') || item;
                        const div = document.createElement('div');
                        div.innerHTML = content.innerHTML;
                        item.parentNode.replaceChild(div, item);
                        newDivs.push(div);
                    });
                    // Re-select all newly-created divs so execCommand covers them all
                    if (newDivs.length > 0) {
                        const newRange = document.createRange();
                        newRange.setStartBefore(newDivs[0]);
                        newRange.setEndAfter(newDivs[newDivs.length - 1]);
                        selection.removeAllRanges();
                        selection.addRange(newRange);
                    }
                }

                if (type === 'h1' || type === 'h2') {
                    document.execCommand('formatBlock', false, type === 'h1' ? 'H1' : 'H2');
                } else if (type === 'bullet' || type === 'number') {
                    if (type === 'bullet') {
                        document.execCommand('insertUnorderedList');
                    } else {
                        document.execCommand('insertOrderedList');
                    }
                } else if (type === 'normal') {
                    if (isBulletActive) document.execCommand('insertUnorderedList');
                    if (isNumberActive) document.execCommand('insertOrderedList');
                    document.execCommand('formatBlock', false, 'div');
                } else if (type === 'todo') {
                    if (selectedCheckItems.length > 0) {
                        // TOGGLE OFF: Convert selected checklists back to plain divs
                        const newDivs = [];
                        selectedCheckItems.forEach(item => {
                            const contentSpan = item.querySelector('span:not(.checklist-checkbox)') || item;
                            const div = document.createElement('div');
                            div.innerHTML = contentSpan.innerHTML;
                            item.parentNode.replaceChild(div, item);
                            newDivs.push(div);
                        });
                        
                        // Restore selection
                        if (newDivs.length > 0) {
                            const newRange = document.createRange();
                            newRange.setStartBefore(newDivs[0]);
                            newRange.setEndAfter(newDivs[newDivs.length - 1]);
                            selection.removeAllRanges();
                            selection.addRange(newRange);
                        }
                        return; // Done with toggle-off
                    }
                    
                    let container = range.startContainer;
                    if (container.nodeType === 3) container = container.parentElement;
                    const inListItem = container.closest('li');

                    if (inListItem && range.collapsed) {
                        const html = inListItem.innerHTML;
                        const wrapper = document.createElement('div');
                        wrapper.className = 'checklist-item';
                        wrapper.innerHTML = `<span class="checklist-checkbox" contenteditable="false"></span><span>${html || '&nbsp;'}</span>`;
                        const list = inListItem.closest('ul, ol');
                        if (list && list.children.length === 1) {
                            list.parentNode.replaceChild(wrapper, list);
                        } else {
                            inListItem.parentNode.replaceChild(wrapper, inListItem);
                        }
                    } else if (range.collapsed) {
                        const wrapper = document.createElement('div');
                        wrapper.className = 'checklist-item';
                        wrapper.innerHTML = '<span class="checklist-checkbox" contenteditable="false"></span><span>&nbsp;</span>';
                        range.insertNode(wrapper);
                        const newRange = document.createRange();
                        const contentSpan = wrapper.querySelector('span:not(.checklist-checkbox)');
                        if (contentSpan) {
                            newRange.setStart(contentSpan, 1);
                            newRange.collapse(true);
                            selection.removeAllRanges();
                            selection.addRange(newRange);
                        }
                    } else {
                        // BATCH CONVERSION  collect items from DOM BEFORE any mutation

                        // 1. Find the parent list or collect block-level elements
                        const startBlock = getBlockParent(range.startContainer);
                        const parentList = startBlock ? startBlock.closest('ul, ol') : null;
                        
                        const lines = [];
                        
                        if (parentList) {
                            // Source is a UL/OL: collect selected LI elements directly
                            const allLIs = Array.from(parentList.querySelectorAll('li'));
                            const selectedLIs = allLIs.filter(li => selection.containsNode(li, true));
                            selectedLIs.forEach(li => lines.push(li.innerHTML));
                            
                            // Remove original items
                            const insertedItems = [];
                            if (selectedLIs.length === allLIs.length) {
                                // All items selected  remove entire list
                                const anchor = parentList;
                                const parent = anchor.parentNode;
                                const frag = document.createDocumentFragment();
                                lines.forEach(l => {
                                    const wrapper = document.createElement('div');
                                    wrapper.className = 'checklist-item';
                                    wrapper.innerHTML = `<span class="checklist-checkbox" contenteditable="false"></span><span>${l}</span>`;
                                    insertedItems.push(wrapper);
                                    frag.appendChild(wrapper);
                                });
                                parent.replaceChild(frag, anchor);
                            } else {
                                // Partial selection  replace only selected LIs, keep list
                                const frag = document.createDocumentFragment();
                                lines.forEach(l => {
                                    const wrapper = document.createElement('div');
                                    wrapper.className = 'checklist-item';
                                    wrapper.innerHTML = `<span class="checklist-checkbox" contenteditable="false"></span><span>${l}</span>`;
                                    insertedItems.push(wrapper);
                                    frag.appendChild(wrapper);
                                });
                                parentList.parentNode.insertBefore(frag, parentList);
                                selectedLIs.forEach(li => li.remove());
                            }
                            // Restore selection across all new checklist items
                            if (insertedItems.length > 0) {
                                const newRange = document.createRange();
                                newRange.setStartBefore(insertedItems[0]);
                                newRange.setEndAfter(insertedItems[insertedItems.length - 1]);
                                selection.removeAllRanges();
                                selection.addRange(newRange);
                            }
                        } else {
                            // Source is plain text / divs / headings  use extract approach
                            const sBlock = getBlockParent(range.startContainer);
                            const eBlock = getBlockParent(range.endContainer);
                            if (sBlock) range.setStartBefore(sBlock);
                            if (eBlock) range.setEndAfter(eBlock);
                            selection.removeAllRanges();
                            selection.addRange(range);

                            const contents = range.extractContents();
                            const tempArr = document.createElement('div');
                            tempArr.appendChild(contents);
                            
                            let buffer = "";
                            const flush = () => {
                                const trimmed = buffer.replace(/&nbsp;/g, ' ').trim();
                                if (trimmed || buffer.includes('<img') || buffer.includes('<span')) {
                                    lines.push(buffer);
                                }
                                buffer = "";
                            };

                            const walk = (node) => {
                                if (node.nodeType === 3) {
                                    buffer += node.textContent;
                                } else if (node.nodeName === 'BR') {
                                    flush();
                                } else if (['DIV', 'P', 'LI', 'UL', 'OL', 'H1', 'H2', 'H3', 'BLOCKQUOTE'].includes(node.nodeName)) {
                                    flush();
                                    Array.from(node.childNodes).forEach(walk);
                                    flush();
                                } else if (node.classList && node.classList.contains('checklist-checkbox')) {
                                    // Skip
                                } else {
                                    buffer += (node.nodeType === 1 ? node.outerHTML : '');
                                }
                            };
                            
                            Array.from(tempArr.childNodes).forEach(walk);
                            flush();

                            const frag = document.createDocumentFragment();
                            const insertedItems2 = [];
                            (lines.length > 0 ? lines : ["&nbsp;"]).forEach(l => {
                                const wrapper = document.createElement('div');
                                wrapper.className = 'checklist-item';
                                wrapper.innerHTML = `<span class="checklist-checkbox" contenteditable="false"></span><span>${l}</span>`;
                                insertedItems2.push(wrapper);
                                frag.appendChild(wrapper);
                            });
                            range.insertNode(frag);
                            // Restore selection across all new checklist items
                            if (insertedItems2.length > 0) {
                                const newRange = document.createRange();
                                newRange.setStartBefore(insertedItems2[0]);
                                newRange.setEndAfter(insertedItems2[insertedItems2.length - 1]);
                                selection.removeAllRanges();
                                selection.addRange(newRange);
                            }
                        }
                    }
                }
                setHasChanges(true);
            };

            const handleEditorKeyDown = (e) => {
                if (e.key === 'Enter') {
                    const selection = window.getSelection();
                    if (!selection.rangeCount) return;
                    
                    const range = selection.getRangeAt(0);
                    const item = range.startContainer.nodeType === 3 ? range.startContainer.parentElement.closest('.checklist-item') : range.startContainer.closest('.checklist-item');
                    
                    if (item) {
                        e.preventDefault();
                        const text = item.textContent.trim();
                        
                        if (text === "") {
                            // Smart Exit: Convert to plain DIV
                            const div = document.createElement('div');
                            div.innerHTML = '&nbsp;';
                            item.parentNode.replaceChild(div, item);
                            
                            const newRange = document.createRange();
                            newRange.setStart(div, 0);
                            newRange.collapse(true);
                            selection.removeAllRanges();
                            selection.addRange(newRange);
                        } else {
                            // Smart Continuation: Insert new checklist item
                            const newItem = document.createElement('div');
                            newItem.className = 'checklist-item';
                            newItem.innerHTML = '<span class="checklist-checkbox" contenteditable="false"></span><span>&nbsp;</span>';
                            
                            item.insertAdjacentElement('afterend', newItem);
                            
                            const newRange = document.createRange();
                            const textSpan = newItem.querySelector('span:not(.checklist-checkbox)');
                            newRange.setStart(textSpan, 1);
                            newRange.collapse(true);
                            selection.removeAllRanges();
                            selection.addRange(newRange);
                        }
                        setHasChanges(true);
                        saveState();
                    }
                }
            };

            const toggleFormat = (marker) => {
                if (marker === '**') document.execCommand('bold', false, null);
                if (marker === '*') document.execCommand('italic', false, null);
                if (marker === '__') document.execCommand('underline', false, null);
                if (marker === '~~') document.execCommand('strikeThrough', false, null);
                setHasChanges(true);
            };

            const toggleHighlight = (color) => {
                document.execCommand('hiliteColor', false, color);
                setHasChanges(true);
            };

            const applyCase = (caseType) => {
                const selection = window.getSelection();
                if (!selection.rangeCount) return;
                
                const range = selection.getRangeAt(0);
                const container = document.createElement('div');
                container.appendChild(range.cloneContents());
                
                const walker = document.createTreeWalker(container, NodeFilter.SHOW_TEXT);
                while (walker.nextNode()) {
                    const node = walker.currentNode;
                    if (caseType === 'upper') node.nodeValue = node.nodeValue.toUpperCase();
                    if (caseType === 'lower') node.nodeValue = node.nodeValue.toLowerCase();
                    if (caseType === 'cap') node.nodeValue = node.nodeValue.split(' ').map(w => w.charAt(0).toUpperCase() + w.slice(1).toLowerCase()).join(' ');
                }
                
                document.execCommand('insertHTML', false, container.innerHTML);
                setHasChanges(true);
            };
            const handleEditorClick = (e) => {
                const target = e.target;
                if (target.classList.contains('checklist-checkbox')) {
                    const li = target.closest('.checklist-item');
                    if (li) {
                        li.classList.toggle('checked');
                        setHasChanges(true);
                        saveState();
                    }
                }
            };
            
            const handleImageResize = (e, targetImage, handleType) => {
                const isTouch = e.type.startsWith('touch');
                const startX = isTouch ? e.touches[0].clientX : e.clientX;
                const initialWidth = targetImage.offsetWidth;
                const editorWidth = editorRef.current ? editorRef.current.offsetWidth : window.innerWidth;

                document.body.classList.add('resizing-active');
                if (handleType === 'br' || handleType === 'tl') {
                    document.body.style.cursor = 'nwse-resize';
                } else {
                    document.body.style.cursor = 'nesw-resize';
                }

                const onMove = (moveEvent) => {
                    const currentX = isTouch ? moveEvent.touches[0].clientX : moveEvent.clientX;
                    const currentY = isTouch ? moveEvent.touches[0].clientY : moveEvent.clientY;
                    
                    if (handleType.startsWith('edge-')) {
                        // Cropping logic
                        const mask = targetImage.parentElement.querySelector('.crop-mask');
                        if (!mask) return;
                        
                        const rect = mask.getBoundingClientRect();
                        const imgRect = targetImage.getBoundingClientRect();
                        
                        if (handleType === 'edge-t') {
                            const newTop = currentY - imgRect.top;
                            mask.style.top = Math.max(0, newTop) + 'px';
                        } else if (handleType === 'edge-b') {
                            const newBottom = imgRect.bottom - currentY;
                            mask.style.bottom = Math.max(0, newBottom) + 'px';
                        } else if (handleType === 'edge-l') {
                            const newLeft = currentX - imgRect.left;
                            mask.style.left = Math.max(0, newLeft) + 'px';
                        } else if (handleType === 'edge-r') {
                            const newRight = imgRect.right - currentX;
                            mask.style.right = Math.max(0, newRight) + 'px';
                        }
                    } else {
                        // Resizing logic
                        let deltaX = 0;
                        if (handleType === 'br' || handleType === 'tr') {
                            deltaX = currentX - startX;
                        } else {
                            deltaX = startX - currentX;
                        }

                        const newWidth = Math.max(50, Math.min(editorWidth - 40, initialWidth + deltaX));
                        targetImage.style.width = newWidth + 'px';
                        targetImage.style.height = 'auto';
                    }
                    
                    if (isTouch) moveEvent.preventDefault(); // Prevent scroll
                };

                const onEnd = () => {
                    document.removeEventListener('mousemove', onMove, true);
                    document.removeEventListener('mouseup', onEnd, true);
                    document.removeEventListener('touchmove', onMove, { passive: false });
                    document.removeEventListener('touchend', onEnd, true);
                    document.body.classList.remove('resizing-active');
                    document.body.style.cursor = '';
                    setHasChanges(true);
                    saveState();
                };

                document.addEventListener('mousemove', onMove, true);
                document.addEventListener('mouseup', onEnd, true);
                document.addEventListener('touchmove', onMove, { passive: false });
                document.addEventListener('touchend', onEnd, true);
            };

            const handlePaste = (e) => {
                e.preventDefault();
                const text = (e.clipboardData || window.clipboardData).getData('text');
                document.execCommand('insertText', false, text);
            };

            const applyCrop = (img) => {
                const container = img.parentElement;
                const mask = container.querySelector('.crop-mask');
                if (!mask) return;

                const maskRect = mask.getBoundingClientRect();
                const imgRect = img.getBoundingClientRect();

                // Calculate ratios relative to displayed image
                const nx = (maskRect.left - imgRect.left) / imgRect.width;
                const ny = (maskRect.top - imgRect.top) / imgRect.height;
                const nw = maskRect.width / imgRect.width;
                const nh = maskRect.height / imgRect.height;

                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                
                const sw = img.naturalWidth;
                const sh = img.naturalHeight;

                canvas.width = sw * nw;
                canvas.height = sh * nh;

                ctx.drawImage(
                    img, 
                    sw * nx, sh * ny, sw * nw, sh * nh,
                    0, 0, canvas.width, canvas.height
                );

                img.src = canvas.toDataURL('image/png');
                img.style.width = maskRect.width + 'px';
                img.style.height = 'auto';
                
                // Reset UI
                container.classList.remove('cropping-active');
                mask.style.display = 'none';
                container.querySelector('.crop-controls').style.display = 'flex';
                container.querySelector('.crop-done-controls').style.display = 'none';
                
                setIsCropping(false);
                setHasChanges(true);
                saveState();
            };

            const handleImageUpload = (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        const imgHtml = `
                            <div class="resizable-image-container selected" contenteditable="false">
                                <div class="crop-controls">
                                    <button class="crop-btn primary" data-action="crop-start">
                                        <span class="material-symbols-outlined text-[16px]">crop_free</span>
                                        Crop
                                    </button>
                                </div>
                                <div class="crop-done-controls" style="display:none">
                                    <button class="crop-btn primary" data-action="crop-done">Done</button>
                                    <button class="crop-btn secondary" data-action="crop-cancel">Cancel</button>
                                </div>
                                <img src="${event.target.result}" class="resizable-image selected" style="width: 250px" />
                                <div class="crop-mask" style="display:none"></div>
                                <div class="resize-handle tl"></div>
                                <div class="resize-handle tr"></div>
                                <div class="resize-handle bl"></div>
                                <div class="resize-handle br"></div>
                                <div class="crop-handle edge-t"></div>
                                <div class="crop-handle edge-b"></div>
                                <div class="crop-handle edge-l"></div>
                                <div class="crop-handle edge-r"></div>
                            </div>
                        `;
                        document.execCommand('insertHTML', false, imgHtml + '<div>&nbsp;</div>');
                        setHasChanges(true);
                        saveState();
                    };
                    reader.readAsDataURL(file);
                }
            };

            useEffect(() => {
                const handleGlobalInteract = (e) => {
                    const target = e.target;
                    const isTouch = e.type.startsWith('touch');
                    
                    // Clear helper
                    const clearAll = () => {
                        document.querySelectorAll('.resizable-image.selected, .resizable-image-container.selected').forEach(el => el.classList.remove('selected'));
                        setSelectedImage(null);
                    };

                    // 1. Handle clicking on an image
                    if (target.classList.contains('resizable-image')) {
                        e.stopPropagation();
                        // On touch, we might not want to prevent default if we want focus, but for selection it's better to prevent.
                        if (!isTouch) e.preventDefault(); 
                        
                        clearAll();
                        const container = target.closest('.resizable-image-container');
                        if (container) container.classList.add('selected');
                        target.classList.add('selected');
                        setSelectedImage(target);
                        return;
                    }
                    
                    // 2. Handle clicking a resize or crop handle
                    if (target.classList.contains('resize-handle') || target.classList.contains('crop-handle')) {
                        e.stopPropagation();
                        e.preventDefault();
                        let handleType = '';
                        if (target.classList.contains('resize-handle')) {
                            handleType = target.classList.contains('tl') ? 'tl' :
                                         target.classList.contains('tr') ? 'tr' :
                                         target.classList.contains('bl') ? 'bl' : 'br';
                        } else {
                            handleType = target.classList.contains('edge-t') ? 'edge-t' :
                                         target.classList.contains('edge-b') ? 'edge-b' :
                                         target.classList.contains('edge-l') ? 'edge-l' : 'edge-r';
                        }
                        
                        const container = target.closest('.resizable-image-container');
                        const img = container ? container.querySelector('img') : null;
                        if (img) handleImageResize(e, img, handleType);
                        return;
                    }

                    // 4. Handle Crop Buttons
                    const action = target.closest('[data-action]') ? target.closest('[data-action]').dataset.action : null;
                    if (action) {
                        e.stopPropagation();
                        e.preventDefault();
                        const container = target.closest('.resizable-image-container');
                        const img = container ? container.querySelector('img') : null;
                        const mask = container ? container.querySelector('.crop-mask') : null;
                        
                        if (action === 'crop-start' && container && img && mask) {
                            setIsCropping(true);
                            container.classList.add('cropping-active');
                            mask.style.display = 'block';
                            mask.style.top = '10%'; mask.style.bottom = '10%';
                            mask.style.left = '10%'; mask.style.right = '10%';
                            container.querySelector('.crop-controls').style.display = 'none';
                            container.querySelector('.crop-done-controls').style.display = 'flex';
                        } else if (action === 'crop-done' && img) {
                            applyCrop(img);
                        } else if (action === 'crop-cancel' && container && mask) {
                            setIsCropping(false);
                            container.classList.remove('cropping-active');
                            mask.style.display = 'none';
                            container.querySelector('.crop-controls').style.display = 'flex';
                            container.querySelector('.crop-done-controls').style.display = 'none';
                        }
                        return;
                    }

                    // 3. Deselect when clicking outside
                    if (selectedImage && !target.closest('.resizable-image-container')) {
                        clearAll();
                    }
                };
                
                document.addEventListener('mousedown', handleGlobalInteract, true);
                document.addEventListener('touchstart', handleGlobalInteract, { capture: true, passive: false });
                
                return () => {
                    document.removeEventListener('mousedown', handleGlobalInteract, true);
                    document.removeEventListener('touchstart', handleGlobalInteract, true);
                };
            }, [selectedImage]);

            var theme = themes.find(function(t) { return t.id === noteTheme; });
            var currentThemeClass = theme ? theme.themeClass : '';

            return (
                <div className={"fixed inset-0 z-[110] flex items-center justify-center p-4 md:p-8 transition-all duration-200 " + (isClosing ? 'opacity-0 scale-95' : 'animate-in fade-in duration-500')}>
                    <div className={"absolute inset-0 bg-black/70 backdrop-blur-2xl transition-opacity duration-200 " + (isClosing ? 'opacity-0' : '')} onClick={handleClose}></div>
                    
                    <div className={"task-creator-modal w-full max-w-4xl h-[85vh] rounded-[2rem] overflow-hidden flex flex-col relative z-10 shadow-2xl transition-all duration-200 ease-out " + (isClosing ? 'scale-95 opacity-0' : 'animate-in zoom-in-95 duration-500') + ' transition-colors duration-500 ' + currentThemeClass}>
                        
                        {/* Top Progress Bar Slider */}
                        <div 
                            className="modal-top-progress cursor-pointer group h-2 bg-black/5 hover:h-3 transition-all"
                            onClick={handleProgressClick}
                        >
                            <div 
                                className="modal-progress-fill h-full bg-primary relative" 
                                style={{ width: progress + "%" }}
                            >
                                <div className="absolute right-0 top-1/2 -translate-y-1/2 w-4 h-4 bg-white rounded-full shadow-lg scale-0 group-hover:scale-100 transition-transform"></div>
                            </div>
                        </div>

                        <div className="flex-1 overflow-y-auto p-8 md:p-10 no-scrollbar relative flex flex-col">
                            {noteIcon && (
                                <div className="absolute top-24 right-10 pointer-events-none opacity-[0.07] select-none">
                                    <span className="material-symbols-outlined text-8xl text-primary animate-in zoom-in-50 duration-700">{noteIcon}</span>
                                </div>
                            )}
                            <div className="flex justify-between items-start mb-4 relative z-10">
                                <div className="flex-1 flex flex-col gap-2">
                                    <input 
                                        type="text" 
                                        placeholder="MAIN TITLE" 
                                        className="bg-transparent border-none text-3xl md:text-4xl font-bold text-slate-800 placeholder:text-slate-300 focus:ring-0 w-full tracking-tight font-display uppercase px-4"
                                        value={title}
                                        onChange={(e) => { setTitle(e.target.value); setHasChanges(true); }}
                                        onBlur={saveState}
                                    />
                                    <div className="flex flex-wrap items-center gap-2 px-4">
                                        {labels.map(label => (
                                            <span key={label} className="text-[10px] font-bold uppercase tracking-widest bg-primary/10 text-primary px-2 py-1 rounded-md flex items-center gap-1">
                                                {label}
                                                <button onClick={() => { setLabels(labels.filter(l => l !== label)); setHasChanges(true); saveState(); }} className="hover:text-primary-dark">
                                                    <span className="material-symbols-outlined text-xs">close</span>
                                                </button>
                                            </span>
                                        ))}
                                        {reminderDate && (
                                            <span className="inline-flex items-center gap-1 text-[10px] font-bold font-montserrat text-primary bg-primary/10 px-2 py-1 rounded-md">
                                                <span className="material-symbols-outlined text-xs">notifications_active</span>
                                                {formatReminderDate(reminderDate)}
                                            </span>
                                        )}
                                    </div>
                                </div>
                                <div className="flex items-center gap-0.5 flex-shrink-0">
                                    <button 
                                        onClick={() => { setIsPinned(!isPinned); saveState(); }}
                                        className={"p-2 rounded-full transition-all " + (isPinned ? "text-primary bg-primary/10" : "text-slate-400 hover:text-slate-600")}
                                    >
                                        <span className="material-symbols-outlined text-[24px]" style={isPinned ? {fontVariationSettings: "'FILL' 1"} : {}}>push_pin</span>
                                    </button>
                                    <button 
                                        onClick={handleClose}
                                        className="p-2 rounded-full text-slate-400 hover:text-slate-600 hover:bg-black/5 transition-all"
                                    >
                                        <span className="material-symbols-outlined text-[24px]">close</span>
                                    </button>
                                </div>
                            </div>
                            <div className="flex-1">
                                <div 
                                    ref={editorRef}
                                    contentEditable="true"
                                    className="note-editor-area"
                                    data-placeholder="Start typing your notes..."
                                    onInput={(e) => { setHasChanges(true); }}
                                    onBlur={saveState}
                                    onClick={handleEditorClick}
                                    onPaste={handlePaste}
                                    onKeyDown={handleEditorKeyDown}
                                    dangerouslySetInnerHTML={{ __html: initialContent }}
                                />
                            </div>

                        </div>

                        {/* Bottom Actions Toolbar */}
                        <div className="task-creator-footer mt-auto flex items-center justify-between gap-4">
                            <div className="flex items-center gap-0.5 md:gap-1 flex-1">
                                {/* Nested Horizontal Formatting Dropdown */}
                                <div className="relative flex-shrink-0">
                                    <button onClick={() => setActivePopup(activePopup === 'format' ? null : 'format')} className={"footer-action-btn h-[32px] w-[32px] flex items-center justify-center transition-all rounded-xl " + (activePopup === 'format' ? "bg-black/5 text-primary" : "text-primary hover:bg-black/5")} title="Formatting">
                                        <span className="material-symbols-outlined text-[20px]">format_color_text</span>
                                    </button>
                                    
                                    {activePopup === 'format' && (
                                        <React.Fragment>
                                            <div className="absolute bottom-full left-0 w-full h-8 bg-transparent"></div>
                                            
                                            {/* Main Horizontal Bar */}
                                            <div className="absolute bottom-[calc(100%+8px)] left-0 bg-white rounded-2xl shadow-xl border border-black/5 flex items-center p-2.5 z-50 animate-in slide-in-from-bottom-2 duration-200">
                                                
                                                {/* Style Sub-menu Trigger */}
                                                <div className="relative group/styleSub">
                                                    <button className="h-10 px-3 flex items-center gap-1.5 hover:bg-black/5 rounded-lg text-slate-600 transition-colors">
                                                        <span className="text-xs font-bold tracking-tight uppercase font-montserrat">Style</span>
                                                        <span className="material-symbols-outlined text-sm">arrow_drop_up</span>
                                                    </button>
                                                    {/* Style Horizontal Bar */}
                                                    <div className="absolute bottom-full left-0 mb-2 bg-white rounded-lg shadow-lg border border-black/5 hidden group-hover/styleSub:flex items-center p-1.5 z-[60] animate-in slide-in-from-bottom-1 duration-200">
                                                        <button onMouseDown={(e) => { e.preventDefault(); convertActiveBlock('h1'); }} className="h-9 px-4 flex items-center hover:bg-black/5 rounded-md text-base font-bold text-slate-700 font-montserrat">H1</button>
                                                        <button onMouseDown={(e) => { e.preventDefault(); convertActiveBlock('h2'); }} className="h-9 px-4 flex items-center hover:bg-black/5 rounded-md text-sm font-bold text-slate-600 font-montserrat">H2</button>
                                                        <button onMouseDown={(e) => { e.preventDefault(); convertActiveBlock('normal'); }} className="h-9 px-4 flex items-center hover:bg-black/5 rounded-md text-sm text-slate-500 font-montserrat">Normal</button>
                                                    </div>
                                                    {/* Bridge */}
                                                    <div className="absolute bottom-full left-0 w-full h-4 bg-transparent"></div>
                                                </div>

                                                <div className="w-px h-7 bg-black/5 mx-1.5"></div>

                                                {/* Case Sub-menu Trigger */}
                                                <div className="relative group/caseSub">
                                                    <button className="h-10 px-3 flex items-center gap-1.5 hover:bg-black/5 rounded-lg text-slate-600 transition-colors">
                                                        <span className="text-xs font-bold tracking-tight uppercase font-montserrat">Case</span>
                                                        <span className="material-symbols-outlined text-sm">arrow_drop_up</span>
                                                    </button>
                                                    {/* Case Horizontal Bar */}
                                                    <div className="absolute bottom-full left-0 mb-2 bg-white rounded-lg shadow-lg border border-black/5 hidden group-hover/caseSub:flex items-center p-1.5 z-[60] animate-in slide-in-from-bottom-1 duration-200">
                                                        <button onMouseDown={(e) => { e.preventDefault(); applyCase('upper'); }} className="h-9 px-4 flex items-center hover:bg-black/5 rounded-md text-xs uppercase font-bold text-slate-600 font-montserrat">AA</button>
                                                        <button onMouseDown={(e) => { e.preventDefault(); applyCase('lower'); }} className="h-9 px-4 flex items-center hover:bg-black/5 rounded-md text-xs lowercase font-bold text-slate-600 font-montserrat">aa</button>
                                                        <button onMouseDown={(e) => { e.preventDefault(); applyCase('cap'); }} className="h-9 px-4 flex items-center hover:bg-black/5 rounded-md text-xs capitalize font-bold text-slate-600 font-montserrat">Aa</button>
                                                    </div>
                                                    {/* Bridge */}
                                                    <div className="absolute bottom-full left-0 w-full h-4 bg-transparent"></div>
                                                </div>

                                                <div className="w-px h-7 bg-black/5 mx-1.5"></div>

                                                {/* Basic Formatting Buttons */}
                                                <div className="flex items-center">
                                                    <button onMouseDown={(e) => { e.preventDefault(); toggleFormat('**'); }} className="w-10 h-10 flex items-center justify-center hover:bg-black/5 rounded-lg text-slate-600" title="Bold">
                                                        <span className="material-symbols-outlined text-xl">format_bold</span>
                                                    </button>
                                                    <button onMouseDown={(e) => { e.preventDefault(); toggleFormat('*'); }} className="w-10 h-10 flex items-center justify-center hover:bg-black/5 rounded-lg text-slate-600" title="Italic">
                                                        <span className="material-symbols-outlined text-xl">format_italic</span>
                                                    </button>
                                                    <button onMouseDown={(e) => { e.preventDefault(); toggleFormat('__'); }} className="w-10 h-10 flex items-center justify-center hover:bg-black/5 rounded-lg text-slate-600" title="Underline">
                                                        <span className="material-symbols-outlined text-xl">format_underlined</span>
                                                    </button>
                                                    <button onMouseDown={(e) => { e.preventDefault(); toggleFormat('~~'); }} className="w-10 h-10 flex items-center justify-center hover:bg-black/5 rounded-lg text-slate-600" title="Strikethrough">
                                                        <span className="material-symbols-outlined text-xl">strikethrough_s</span>
                                                    </button>
                                                </div>

                                                <div className="w-px h-7 bg-black/5 mx-1.5"></div>

                                                {/* Alignment Buttons */}
                                                <div className="flex items-center">
                                                    <button onMouseDown={(e) => { e.preventDefault(); document.execCommand('justifyLeft'); }} className="w-10 h-10 flex items-center justify-center hover:bg-black/5 rounded-lg text-slate-600" title="Align Left">
                                                        <span className="material-symbols-outlined text-xl">format_align_left</span>
                                                    </button>
                                                    <button onMouseDown={(e) => { e.preventDefault(); document.execCommand('justifyCenter'); }} className="w-10 h-10 flex items-center justify-center hover:bg-black/5 rounded-lg text-slate-600" title="Align Center">
                                                        <span className="material-symbols-outlined text-xl">format_align_center</span>
                                                    </button>
                                                    <button onMouseDown={(e) => { e.preventDefault(); document.execCommand('justifyRight'); }} className="w-10 h-10 flex items-center justify-center hover:bg-black/5 rounded-lg text-slate-600" title="Align Right">
                                                        <span className="material-symbols-outlined text-xl">format_align_right</span>
                                                    </button>
                                                </div>

                                                <div className="w-px h-7 bg-black/5 mx-1.5"></div>

                                                <div className="relative group/highlightSub">
                                                    <button className="h-10 px-3 flex items-center gap-1.5 hover:bg-black/5 rounded-lg text-slate-600 transition-colors">
                                                        <span className="material-symbols-outlined text-xl">ink_highlighter</span>
                                                        <span className="material-symbols-outlined text-sm">arrow_drop_up</span>
                                                    </button>
                                                    {/* Highlight Horizontal Bar (8x2 grid) */}
                                                    <div className="absolute bottom-full left-0 mb-2 p-3 bg-white rounded-xl shadow-2xl border border-black/5 hidden group-hover/highlightSub:block z-[60] animate-in slide-in-from-bottom-1 duration-200">
                                                        <div className="grid grid-cols-8 gap-2 w-max">
                                                            <button 
                                                                onMouseDown={(e) => { e.preventDefault(); toggleHighlight('transparent'); }}
                                                                className="highlight-option flex items-center justify-center bg-white border-dashed"
                                                                title="No Highlight"
                                                            >
                                                                <span className="material-symbols-outlined text-xs text-slate-400">format_color_reset</span>
                                                            </button>
                                                            {['#fed7aa', '#fef08a', '#bbf7d0', '#bfdbfe', '#ddd6fe', '#fecaca', '#f5f5f5', '#ffedd5', '#fef9c3', '#dcfce7', '#dbeafe', '#f3e8ff', '#ffe4e6', '#ccfbf1', '#fef3c7'].map(c => (
                                                                <button 
                                                                    key={c}
                                                                    onMouseDown={(e) => { e.preventDefault(); toggleHighlight(c); }}
                                                                    className="highlight-option" 
                                                                    style={{ backgroundColor: c }}
                                                                />
                                                            ))}
                                                        </div>
                                                    </div>
                                                    {/* Bridge */}
                                                    <div className="absolute bottom-full left-0 w-full h-4 bg-transparent"></div>
                                                </div>
                                            </div>
                                        </React.Fragment>
                                    )}
                                </div>
                                
                                <div className="w-px h-6 bg-black/5 mx-1 flex-shrink-0"></div>

                                <button onClick={() => convertActiveBlock('todo')} className="footer-action-btn flex-shrink-0" title="Checklist">
                                    <span className="material-symbols-outlined text-[22px]">checklist</span>
                                </button>
                                <button onClick={() => convertActiveBlock('bullet')} className="footer-action-btn flex-shrink-0" title="Bullets">
                                    <span className="material-symbols-outlined text-[22px]">format_list_bulleted</span>
                                </button>
                                <button onClick={() => convertActiveBlock('number')} className="footer-action-btn flex-shrink-0" title="Numbers">
                                    <span className="material-symbols-outlined text-[22px]">format_list_numbered</span>
                                </button>
                                
                                <div className="footer-divider flex-shrink-0"></div>

                                {/* Rest of Footer Icons */}
                                <div className="relative flex-shrink-0">
                                    <button onClick={() => setActivePopup(activePopup === 'reminder' ? null : 'reminder')} className={"footer-action-btn " + (activePopup === 'reminder' ? "bg-black/5 text-primary" : "")} title="Reminders">
                                        <span className="material-symbols-outlined text-[22px]">notifications</span>
                                    </button>
                                    {activePopup === 'reminder' && (
                                        <div className="absolute bottom-full mb-4 left-0 bg-white rounded-xl shadow-2xl border border-black/5 z-50 w-72 animate-in slide-in-from-bottom-2 duration-300 py-2">
                                            {!showCustomReminder ? (
                                                <div className="flex flex-col">
                                                    <div className="px-5 py-3 border-b border-black/5 mb-1">
                                                        <p className="text-sm font-semibold text-slate-800 font-montserrat">Remind me later</p>
                                                       
                                                    </div>
                                                    
                                                    <button onClick={() => { setReminderDate(new Date().toISOString().split('T')[0] + 'T18:00'); setActivePopup(null); }} className="px-5 py-3 hover:bg-black/5 flex items-center justify-between text-sm text-slate-600 transition-colors font-montserrat">
                                                        <span>Later today</span>
                                                        <span className="text-xs text-slate-400 font-montserrat">6:00 PM</span>
                                                    </button>
                                                    <button onClick={() => { 
                                                        const tomorrow = new Date(); tomorrow.setDate(tomorrow.getDate() + 1);
                                                        setReminderDate(tomorrow.toISOString().split('T')[0] + 'T08:00'); setActivePopup(null); 
                                                    }} className="px-5 py-3 hover:bg-black/5 flex items-center justify-between text-sm text-slate-600 transition-colors font-montserrat">
                                                        <span>Tomorrow</span>
                                                        <span className="text-xs text-slate-400 font-montserrat">8:00 AM</span>
                                                    </button>
                                                    <button onClick={() => { 
                                                        const nextWeek = new Date(); nextWeek.setDate(nextWeek.getDate() + 7);
                                                        setReminderDate(nextWeek.toISOString().split('T')[0] + 'T08:00'); setActivePopup(null); 
                                                    }} className="px-5 py-3 hover:bg-black/5 flex items-center justify-between text-sm text-slate-600 transition-colors font-montserrat">
                                                        <span>Next week</span>
                                                        <span className="text-xs text-slate-400 font-montserrat">Mon, 8:00 AM</span>
                                                    </button>
                                                    
                                                    <div className="h-px bg-black/5 my-1"></div>
                                                    
                                                    <button onClick={() => setShowCustomReminder(true)} className="px-5 py-3 hover:bg-black/5 flex items-center gap-3 text-sm text-slate-700 font-semibold transition-colors font-montserrat">
                                                        <span className="material-symbols-outlined text-lg">schedule</span>
                                                        <span className="font-montserrat">Pick date & time</span>
                                                    </button>
                                                </div>
                                            ) : (
                                                <div className="p-4">
                                                    <div className="flex items-center gap-2 mb-4">
                                                        <button onClick={() => setShowCustomReminder(false)} className="p-1.5 hover:bg-black/5 rounded-full text-slate-500 transition-colors">
                                                            <span className="material-symbols-outlined text-lg">arrow_back</span>
                                                        </button>
                                                        <span className="text-sm font-bold text-slate-700 font-montserrat">Pick date & time</span>
                                                    </div>
                                                    
                                                    <div className="space-y-4">
                                                        <div className="relative border-b border-black/10 focus-within:border-primary transition-colors">
                                                            <input 
                                                                type="date" 
                                                                className="w-full bg-transparent border-none p-2 text-sm focus:ring-0 text-slate-600 font-montserrat"
                                                                value={reminderDate.split('T')[0] || ""}
                                                                onChange={(e) => { 
                                                                    const newDate = e.target.value;
                                                                    const currentTime = reminderDate.split('T')[1] || "08:00";
                                                                    setReminderDate(`${newDate}T${currentTime}`); 
                                                                    setHasChanges(true); 
                                                                }}
                                                            />
                                                        </div>
                                                        <div className="relative border-b border-black/10 focus-within:border-primary transition-colors">
                                                            <input 
                                                                type="time" 
                                                                className="w-full bg-transparent border-none p-2 text-sm focus:ring-0 text-slate-600 font-montserrat"
                                                                value={reminderDate.split('T')[1] || "08:00"}
                                                                onChange={(e) => { 
                                                                    const newTime = e.target.value;
                                                                    const currentDate = reminderDate.split('T')[0] || new Date().toISOString().split('T')[0];
                                                                    setReminderDate(`${currentDate}T${newTime}`); 
                                                                    setHasChanges(true); 
                                                                }}
                                                            />
                                                        </div>
                                                        <div className="relative border-b border-black/10">
                                                            <select className="w-full bg-transparent border-none p-2 text-sm focus:ring-0 text-slate-600 appearance-none font-montserrat">
                                                                <option>Does not repeat</option>
                                                                <option>Daily</option>
                                                                <option>Weekly</option>
                                                                <option>Monthly</option>
                                                            </select>
                                                        </div>
                                                    </div>

                                                    <div className="flex justify-end mt-6">
                                                        <button onClick={() => setActivePopup(null)} className="px-6 py-2 text-sm font-bold text-slate-800 hover:bg-black/5 rounded-lg transition-all font-montserrat">
                                                            Save
                                                        </button>
                                                    </div>
                                                </div>
                                            )}
                                        </div>
                                    )}
                                </div>
                                <div className="relative flex-shrink-0">
                                    <button onClick={() => setActivePopup(activePopup === 'palette' ? null : 'palette')} className={"footer-action-btn " + (activePopup === 'palette' ? "bg-black/5 text-black" : "")} title="Theme">
                                        <span className="material-symbols-outlined text-[22px]">palette</span>
                                    </button>
                                    {activePopup === 'palette' && (
                                        <div className="absolute bottom-full mb-4 left-0 flex gap-1.5 p-2 bg-white rounded-xl shadow-2xl border border-black/5 z-50">
                                            {themes.map(t => (
                                                <button 
                                                    key={t.id}
                                                    onClick={() => { setNoteTheme(t.id); setActivePopup(null); setHasChanges(true); saveState(); }}
                                                    className={"w-8 h-8 rounded-full border-2 transition-all hover:scale-110 " + (noteTheme === t.id ? "border-primary" : "border-transparent")}
                                                    style={{ backgroundColor: t.id === 'glass' ? 'rgba(0,0,0,0.05)' : t.color }}
                                                />
                                            ))}
                                        </div>
                                    )}
                                </div>
                                    <button onClick={() => fileInputRef.current.click()} className="footer-action-btn flex-shrink-0" title="Add Image">
                                        <span className="material-symbols-outlined text-[22px]">image</span>
                                    </button>
                                    <input 
                                        type="file" 
                                        ref={fileInputRef} 
                                        className="hidden" 
                                        accept="image/*" 
                                        onChange={handleImageUpload}
                                    />
                                <div className="relative flex-shrink-0">
                                    <button onClick={() => setActivePopup(activePopup === 'icon' ? null : 'icon')} className={"footer-action-btn " + (activePopup === 'icon' ? "bg-black/5 text-primary" : "")} title="Choose Icon">
                                        <span className="material-symbols-outlined text-[22px]">add_reaction</span>
                                    </button>
                                    {activePopup === 'icon' && (
                                        <div className="absolute bottom-full mb-4 -left-2 flex flex-col p-3 bg-white rounded-2xl shadow-2xl border border-black/5 z-[120] w-64 animate-in slide-in-from-bottom-2 duration-200">
                                            <div className="search-bar-container">
                                                <span className="material-symbols-outlined text-slate-400 text-lg">search</span>
                                                <input 
                                                    type="text" 
                                                    placeholder="Search icons..." 
                                                    className="search-input bg-transparent"
                                                    value={searchTerm}
                                                    onChange={(e) => setSearchTerm(e.target.value)}
                                                    autoFocus
                                                />
                                            </div>
                                            <div className="max-h-48 overflow-y-auto no-scrollbar grid grid-cols-4 gap-2 w-full pr-1 px-1">
                                                {filteredIcons.map(icon => (
                                                    <button 
                                                        key={icon}
                                                        onClick={() => { setNoteIcon(icon); setActivePopup(null); setHasChanges(true); saveState(); }}
                                                        className={"p-2 rounded-xl border border-transparent hover:border-primary/20 hover:bg-primary/5 transition-all flex items-center justify-center " + (noteIcon === icon ? "text-primary bg-primary/10" : "text-slate-400")}
                                                        title={icon}
                                                    >
                                                        <span className="material-symbols-outlined text-[20px]">{icon}</span>
                                                    </button>
                                                ))}
                                                {filteredIcons.length === 0 && (
                                                    <div className="col-span-4 py-4 text-center text-xs text-slate-400">No icons found</div>
                                                )}
                                            </div>
                                            <div className="h-px bg-slate-100 my-2 mx-1"></div>
                                            <button 
                                                onClick={() => { setNoteIcon(""); setActivePopup(null); setHasChanges(true); saveState(); }}
                                                className="mx-1 p-2 rounded-xl border border-dashed border-slate-200 text-slate-400 hover:text-red-400 hover:bg-red-50 transition-all flex items-center justify-center gap-2 text-[10px] font-bold uppercase tracking-wider"
                                            >
                                                <span className="material-symbols-outlined text-[18px]">block</span>
                                                Remove Icon
                                            </button>
                                        </div>
                                    )}
                                </div>
                                <div className="relative flex-shrink-0">
                                     <button onClick={(e) => { e.stopPropagation(); setActivePopup(activePopup === 'more' ? null : 'more'); }} className={"footer-action-btn " + (activePopup === 'more' ? "bg-black/5 text-primary" : "")} title="More Options">
                                         <span className="material-symbols-outlined text-[22px]">more_vert</span>
                                     </button>
                                    {activePopup === 'more' && (
                                        <div className="more-menu-dropdown z-[120] animate-in slide-in-from-bottom-2 duration-200">
                                            <button onClick={() => { setActivePopup('labels'); }} className="menu-item font-montserrat">
                                                <span className="material-symbols-outlined text-lg">label</span>
                                                Add Label
                                            </button>
                                            <button onClick={() => { 
                                                if(confirm("Duplicate this note?")) {
                                                    alert("Note duplicated (Simulated)");
                                                    setActivePopup(null);
                                                }
                                            }} className="menu-item font-montserrat">
                                                <span className="material-symbols-outlined text-lg">content_copy</span>
                                                Duplicate Note
                                            </button>
                                            <button onClick={() => { setActivePopup('history'); }} className="menu-item font-montserrat">
                                                <span className="material-symbols-outlined text-lg">history</span>
                                                Version History
                                            </button>
                                            <div className="h-px bg-slate-100 my-1"></div>
                                            <button 
                                                onClick={handleDeleteNote}
                                                className="menu-item danger font-montserrat"
                                            >
                                                <span className="material-symbols-outlined text-lg">delete</span>
                                                Delete Note
                                            </button>
                                        </div>
                                    )}
                                    {activePopup === 'labels' && (
                                        <div className="more-menu-dropdown z-[120] w-56 animate-in scale-95 duration-200">
                                            <div className="flex items-center gap-2 mb-3 p-1">
                                                <button onClick={() => setActivePopup('more')} className="p-1 hover:bg-slate-100 rounded-full">
                                                    <span className="material-symbols-outlined text-sm">arrow_back</span>
                                                </button>
                                                <span className="text-xs font-bold uppercase tracking-widest text-slate-400">Add Label</span>
                                            </div>
                                            <div className="flex flex-col gap-1 mb-2 max-h-40 overflow-y-auto no-scrollbar">
                                                {["Strategy", "Personal", "Work", "Urgent"].map(l => (
                                                    <button key={l} onClick={() => { if(!labels.includes(l)) setLabels([...labels, l]); setActivePopup(null); setHasChanges(true); saveState(); }} className="menu-item !py-2 justify-between font-montserrat">
                                                        <span>{l}</span>
                                                        {labels.includes(l) && <span className="material-symbols-outlined text-primary text-sm">check</span>}
                                                    </button>
                                                ))}
                                            </div>
                                            <div className="h-px bg-slate-100 my-1"></div>
                                            <div className="flex gap-1 p-1">
                                                <input 
                                                    type="text" 
                                                    placeholder="Custom label..." 
                                                    className="flex-1 bg-slate-50 border-none rounded-lg px-2 py-1.5 text-xs outline-none focus:ring-1 focus:ring-primary/30"
                                                    value={newLabelText}
                                                    onChange={e => setNewLabelText(e.target.value)}
                                                    onKeyDown={e => {
                                                        if(e.key === 'Enter' && newLabelText.trim()) {
                                                            if(!labels.includes(newLabelText.trim())) setLabels([...labels, newLabelText.trim()]);
                                                            setNewLabelText("");
                                                            setActivePopup(null);
                                                            setHasChanges(true);
                                                            saveState();
                                                        }
                                                    }}
                                                />
                                            </div>
                                        </div>
                                    )}
                                    {activePopup === 'history' && (
                                        <div className="more-menu-dropdown z-[120] w-72 p-0 overflow-hidden animate-in slide-in-from-bottom-2 duration-200">
                                            <div className="p-4 border-b border-slate-100 flex items-center justify-between bg-slate-50">
                                                <div className="flex items-center gap-2">
                                                    <button onClick={() => setActivePopup('more')} className="p-1 hover:bg-slate-200 rounded-full">
                                                        <span className="material-symbols-outlined text-sm">arrow_back</span>
                                                    </button>
                                                    <span className="text-sm font-bold text-slate-800 font-montserrat tracking-tight">Version history</span>
                                                </div>
                                                <button onClick={() => setActivePopup(null)} className="text-slate-400 hover:text-slate-600">
                                                    <span className="material-symbols-outlined text-lg">close</span>
                                                </button>
                                            </div>
                                            <div className="max-h-64 overflow-y-auto no-scrollbar p-1">
                                                {[
                                                    { date: 'Feb 27, 11:27 AM', user: 'You', current: true },
                                                    { date: 'Feb 26, 1:38 PM', user: 'You' },
                                                    { date: 'Nov 15, 2025, 8:15 AM', user: 'You' }
                                                ].map((v, i) => (
                                                    <div key={i} className="p-3 hover:bg-slate-50 rounded-xl flex items-center justify-between group">
                                                        <div className="flex flex-col">
                                                            <div className="flex items-center gap-2">
                                                                <span className="material-symbols-outlined text-slate-400 text-sm">article</span>
                                                                <span className="text-xs font-bold text-slate-700">{v.date}</span>
                                                            </div>
                                                            <span className="text-[10px] text-slate-400 ml-6 uppercase tracking-wider font-bold">{v.current ? 'Current Version' : v.user}</span>
                                                        </div>
                                                        <button className="text-xs font-bold text-primary opacity-0 group-hover:opacity-100 transition-opacity">Download</button>
                                                    </div>
                                                ))}
                                            </div>
                                            <div className="p-3 bg-slate-50 flex justify-end">
                                                <button onClick={() => setActivePopup(null)} className="text-xs font-bold text-slate-800 hover:text-primary">Dismiss</button>
                                            </div>
                                        </div>
                                    )}
                                </div>
                                <div className="footer-divider flex-shrink-0"></div>
                                <button onClick={undo} disabled={historyIndex <= 0} className="footer-action-btn flex-shrink-0 disabled:opacity-20" title="Undo">
                                    <span className="material-symbols-outlined text-[22px]">undo</span>
                                </button>
                                <button onClick={redo} disabled={historyIndex >= history.length - 1} className="footer-action-btn flex-shrink-0 disabled:opacity-20" title="Redo">
                                    <span className="material-symbols-outlined text-[22px]">redo</span>
                                </button>
                            </div>

                            <div className="flex items-center gap-3">
                                {/* Auto-save status could go here if we wanted a small indicator, but the toast handles it well */}
                            </div>
                        </div>
                    </div>
                    {showConfirm.show && (
                        <ConfirmationModal 
                            title={showConfirm.title}
                            message={showConfirm.message}
                            onConfirm={showConfirm.onConfirm}
                            onCancel={() => setShowConfirm({ show: false })}
                            type={showConfirm.type}
                        />
                    )}
                    {showDeleteConfirm && (
                        <ConfirmationModal 
                            title="Delete Note?"
                            message="Are you sure you want to delete this note? This cannot be undone."
                            onConfirm={confirmDeleteNote}
                            onCancel={() => setShowDeleteConfirm(false)}
                            confirmText="Delete"
                            type="danger"
                        />
                    )}
                </div>
            );
        };
        const LoginModal = () => {
            const handleLogin = () => {
                auth.signInWithPopup(googleProvider)
                    .then(() => localStorage.setItem('faiora_logged_in', 'true'))
                    .catch(e => console.error("Login failed", e));
            };

            return (
                <div className="fixed inset-0 z-[100] flex items-center justify-center p-6 blur-overlay overflow-hidden">
                    <div className="absolute inset-0 z-0">
                        <div className="absolute top-1/4 left-1/4 w-96 h-96 bg-primary/20 rounded-full blur-[120px] animate-pulse"></div>
                        <div className="absolute bottom-1/4 right-1/4 w-96 h-96 bg-burnt-orange/30 rounded-full blur-[120px] animate-pulse delay-1000"></div>
                    </div>
                    
                    <div className="glass-panel max-w-xl w-full p-12 rounded-[3.5rem] flex flex-col items-center text-center relative z-10 shadow-2xl border-white/10">
                        <div className="mb-10 relative">
                             <div className="flame-container flex justify-center !static h-16 mb-4">
                                 {[...Array(3)].map((_, i) => (
                                     <div key={i} className="flame-tongue !w-16 !h-24 mx-2" style={{animationDelay: (i * 0.2) + "s"}}></div>
                                 ))}
                             </div>
                             <h2 className="text-8xl font-black text-cream-light italic tracking-tighter drop-shadow-[0_0_50px_rgba(249,115,22,0.4)]">Faiora</h2>
                             <p className="text-primary font-bold uppercase tracking-[0.8em] text-sm mt-4">Ignite your productivity</p>
                        </div>

                        <p className="text-cream-light/60 text-lg mb-12 max-w-md font-sans leading-relaxed">
                            Experience a fiery approach to digital planning. Sync your lists, tasks, and goals with Google and light up your potential.
                        </p>

                        <button 
                            onClick={handleLogin}
                            className="bg-white text-black py-5 px-10 rounded-3xl font-bold flex items-center gap-4 hover:bg-primary hover:text-white transition-all duration-500 hover:scale-105 active:scale-95 shadow-xl group mb-12"
                        >
                            <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" className="w-6 h-6 group-hover:invert transition-all" alt="Google" />
                            <span className="text-xl">Login with Google</span>
                        </button>

                        <div className="flex gap-8 text-[10px] uppercase tracking-widest font-bold text-cream-light/20">
                            <a href="https://johnpaulinso.github.io/Faiora/privacy.html" className="hover:text-primary transition-colors">Privacy Policy</a>
                            <a href="https://johnpaulinso.github.io/Faiora/terms.html" className="hover:text-primary transition-colors">Terms of Service</a>
                        </div>
                    </div>
                </div>
            );
        };

        // --- Page Components ---

        const ConfirmationModal = ({ title, message, onConfirm, onCancel, confirmText = "Confirm", cancelText = "Cancel", type = "danger" }) => {
            return (
                <div className="fixed inset-0 z-[100] flex items-center justify-center p-4 md:p-10 modal-overlay animation-fade-in">
                    <div className="w-full max-w-sm bg-white/95 dark:bg-[#1a1a1a]/95 backdrop-blur-xl rounded-3xl overflow-hidden shadow-2xl border border-white/10 p-8 text-center space-y-6 transform scale-up-center font-montserrat">
                        <div className={`w-16 h-16 mx-auto rounded-full flex items-center justify-center ${type === 'danger' ? 'bg-rose-500/10 text-rose-500' : 'bg-primary/10 text-primary'}`}>
                            <span className="material-symbols-outlined text-3xl">{type === 'danger' ? 'warning' : 'info'}</span>
                        </div>
                        <div className="space-y-2">
                            <h3 className="text-xl font-bold dark:text-cream-light tracking-tight">{title}</h3>
                            <p className="text-sm dark:text-cream-light/60 leading-relaxed font-medium">{message}</p>
                        </div>
                        <div className="flex flex-col gap-3">
                            <button 
                                onClick={onConfirm}
                                className={`w-full py-4 rounded-2xl font-bold uppercase tracking-widest text-[10px] transition-all ${type === 'danger' ? 'bg-rose-500 hover:bg-rose-600 shadow-lg shadow-rose-500/20' : 'bg-primary hover:bg-primary-dark shadow-lg shadow-primary/20'} text-white`}
                            >
                                {confirmText}
                            </button>
                            <button 
                                onClick={onCancel}
                                className="w-full py-4 rounded-2xl font-bold uppercase tracking-widest text-[10px] transition-all bg-black/5 dark:bg-white/5 dark:text-cream-light/60 hover:bg-black/10 dark:hover:bg-white/10"
                            >
                                {cancelText}
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        // --- Shared Helpers ---
        const getThemeClasses = (themeId) => {
            const maps = {
                'amber':    { bg: 'bg-amber-50',    border: 'border-amber-200/60',   icon: 'text-amber-600/60',   text: 'text-amber-950',   sub: 'text-amber-900/60',   label: 'text-amber-800',   labelBg: 'bg-amber-200/50',   chipBg: 'bg-amber-100', chipBorder: 'border-amber-300/40' },
                'orange':   { bg: 'bg-orange-50',   border: 'border-orange-200/60',  icon: 'text-orange-600/60',  text: 'text-orange-950',  sub: 'text-orange-900/60',  label: 'text-orange-800',  labelBg: 'bg-orange-200/50',  chipBg: 'bg-orange-100', chipBorder: 'border-orange-300/40' },
                'peach':    { bg: 'bg-orange-50',    border: 'border-orange-200/60',  icon: 'text-orange-500/60',  text: 'text-orange-950',  sub: 'text-orange-900/60',  label: 'text-orange-800',  labelBg: 'bg-orange-100/60',  chipBg: 'bg-orange-100', chipBorder: 'border-orange-200/50' },
                'yellow':   { bg: 'bg-yellow-50',   border: 'border-yellow-200/60',  icon: 'text-yellow-700/60',  text: 'text-yellow-950',  sub: 'text-yellow-900/60',  label: 'text-yellow-800',  labelBg: 'bg-yellow-200/50',  chipBg: 'bg-yellow-100', chipBorder: 'border-yellow-300/40' },
                'glass':    { bg: 'bg-white/5',      border: 'border-white/10',       icon: 'text-primary/60',     text: 'text-cream-light', sub: 'text-cream-light/50', label: 'text-cream-light/80', labelBg: 'bg-white/10',    chipBg: 'bg-white/10',  chipBorder: 'border-white/15' },
                'sage':     { bg: 'bg-emerald-50',   border: 'border-emerald-200/60', icon: 'text-emerald-600/60', text: 'text-emerald-950', sub: 'text-emerald-900/60', label: 'text-emerald-800', labelBg: 'bg-emerald-200/50', chipBg: 'bg-emerald-100', chipBorder: 'border-emerald-300/40' },
                'sky':      { bg: 'bg-sky-50',       border: 'border-sky-200/60',     icon: 'text-sky-600/60',     text: 'text-sky-950',     sub: 'text-sky-900/60',     label: 'text-sky-800',     labelBg: 'bg-sky-200/50',     chipBg: 'bg-sky-100',    chipBorder: 'border-sky-300/40' },
                'lavender': { bg: 'bg-indigo-50',    border: 'border-indigo-200/60',  icon: 'text-indigo-600/60',  text: 'text-indigo-950',  sub: 'text-indigo-900/60',  label: 'text-indigo-800',  labelBg: 'bg-indigo-200/50',  chipBg: 'bg-indigo-100', chipBorder: 'border-indigo-300/40' },
                'rose':     { bg: 'bg-rose-50',      border: 'border-rose-200/60',    icon: 'text-rose-600/60',    text: 'text-rose-950',    sub: 'text-rose-900/60',    label: 'text-rose-800',    labelBg: 'bg-rose-200/50',    chipBg: 'bg-rose-100',   chipBorder: 'border-rose-300/40' },
                'slate':    { bg: 'bg-slate-100',    border: 'border-slate-300/60',   icon: 'text-slate-600/60',   text: 'text-slate-950',   sub: 'text-slate-700/60',   label: 'text-slate-700',   labelBg: 'bg-slate-200/50',   chipBg: 'bg-slate-200',  chipBorder: 'border-slate-300/40' },
                'teal':     { bg: 'bg-teal-50',      border: 'border-teal-200/60',    icon: 'text-teal-600/60',    text: 'text-teal-950',    sub: 'text-teal-900/60',    label: 'text-teal-800',    labelBg: 'bg-teal-200/50',    chipBg: 'bg-teal-100',   chipBorder: 'border-teal-300/40' },
                'indigo':   { bg: 'bg-violet-50',    border: 'border-violet-200/60',  icon: 'text-violet-600/60',  text: 'text-violet-950',  sub: 'text-violet-900/60',  label: 'text-violet-800',  labelBg: 'bg-violet-200/50',  chipBg: 'bg-violet-100', chipBorder: 'border-violet-300/40' }
            };
            return maps[themeId] || maps['peach'];
        };

        const formatReminderDate = (dateStr) => {
            try {
                const d = new Date(dateStr);
                if (isNaN(d.getTime())) return dateStr;
                const month = d.toLocaleString('en-US', { month: 'short' });
                const day = d.getDate();
                const year = d.getFullYear();
                const time = d.toLocaleString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true });
                return `${month} ${day}, ${year} - ${time}`;
            } catch(e) { return dateStr; }
        };

        const stripHtml = (html) => {
            if (!html) return '';
            const tmp = document.createElement('div');
            tmp.innerHTML = html;
            return tmp.textContent || tmp.innerText || '';
        };

        const NoteCard = ({ note, onClick, index, variant = 'full' }) => {
            const theme = getThemeClasses(note.noteTheme);
            const preview = stripHtml(note.content);
            const isCompact = variant === 'compact';

            return (
                <div 
                    onClick={onClick}
                    className={`card-glow sticky-note-${(index % 5) + 1} ${isCompact ? 'rounded-2xl p-5 min-h-[180px]' : 'rounded-3xl p-7 min-h-[220px]'} flex flex-col border-b-4 group cursor-pointer relative overflow-hidden font-montserrat ${theme.bg} ${theme.border}`}
                >
                    <div className="absolute top-4 right-4">
                        <span className={`material-symbols-outlined text-xl ${theme.icon}`} style={note.isPinned ? {fontVariationSettings: "'FILL' 1"} : {}}>{note.noteIcon || 'push_pin'}</span>
                    </div>
                    <h3 className={`${isCompact ? 'text-lg' : 'text-xl'} font-bold pr-8 tracking-tight ${theme.text}`}>{note.title || "Untitled"}</h3>
                    {preview && (
                        <p className={`${isCompact ? 'text-xs line-clamp-2 mt-1.5' : 'text-sm line-clamp-3 mt-2'} leading-relaxed font-sans ${theme.sub}`}>{preview}</p>
                    )}
                    <div className="mt-auto pt-3 flex flex-col gap-2">
                        {note.reminderDate && (
                            <div className={`inline-flex items-center gap-1.5 text-[10px] font-bold font-montserrat ${theme.chipBg} ${theme.label} px-2.5 py-1.5 rounded-lg w-max border ${theme.chipBorder}`}>
                                <span className="material-symbols-outlined text-xs">notifications_active</span>
                                <span>{formatReminderDate(note.reminderDate)}</span>
                            </div>
                        )}
                        {note.labels && note.labels.length > 0 && (
                            <div className="flex flex-wrap gap-1.5">
                                {note.labels.map(l => (
                                    <span key={l} className={`text-[10px] font-bold uppercase tracking-widest font-montserrat ${theme.labelBg} ${theme.label} px-2.5 py-1 rounded-lg`}>{l}</span>
                                ))}
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        // --- Page Components ---

        const DashboardPage = ({ user, notes, onOpenCreator, onEditNote, onRestoreDefaults }) => {
            const pinnedNotes = notes.filter(n => n.isPinned).slice(0, 5);
            const recentNotes = notes.filter(n => !n.isPinned).slice(0, 5);
            const displayNotes = pinnedNotes.length > 0 ? pinnedNotes : notes.slice(0, 5);

            return (
                <Layout onOpenCreator={onOpenCreator}>
                    <div className="max-w-7xl mx-auto w-full px-6 md:px-16 pt-0 md:pt-12 pb-12">
                        <Header user={user} />
                        <section className="mb-16">
                            <div className="flex items-center gap-4 mb-10">
                                <h2 className="hidden md:block text-2xl font-bold text-cream-light/90 uppercase tracking-[0.3em]">TO-DO LIST</h2>
                                <h2 className="md:hidden text-xl font-bold text-cream-light/90 uppercase tracking-[0.3em]">STICKY NOTES</h2>
                                <div className="h-[1px] flex-1 bg-gradient-to-r from-primary/30 to-transparent"></div>
                                {notes.length > 5 && (
                                    <Link to="/notes" className="text-[10px] font-bold text-primary/60 uppercase tracking-widest hover:text-primary transition-colors">
                                        View All ({notes.length})
                                    </Link>
                                )}
                            </div>
                            
                            {notes.length === 0 ? (
                                <div className="flex flex-col items-center justify-center p-20 glass-panel rounded-3xl border-dashed border-white/10 text-center">
                                    <span className="material-symbols-outlined text-6xl text-white/5 mb-4">description</span>
                                    <p className="text-white/40 font-medium mb-4 font-montserrat">No sticky notes found</p>
                                    <button 
                                        onClick={onRestoreDefaults}
                                        className="px-6 py-2 bg-primary/20 hover:bg-primary/30 text-primary border border-primary/30 rounded-xl text-xs font-bold uppercase tracking-widest transition-all font-montserrat"
                                    >
                                        Restore Default Notes
                                    </button>
                                </div>
                            ) : (
                                <div className="grid grid-cols-2 lg:grid-cols-6 gap-6 px-2 mb-20">
                                    {displayNotes.map((note, index) => {
                                        const theme = getThemeClasses(note.noteTheme);
                                        return (
                                            <div 
                                                key={note.id}
                                                onClick={() => onEditNote(note)}
                                                className={`card-glow sticky-note-${(index % 5) + 1} aspect-square rounded-2xl p-6 flex flex-col justify-between border-b-4 group cursor-pointer relative overflow-hidden ${theme.bg} ${theme.border}`}
                                            >
                                                <div className="flex justify-start">
                                                    <span className={`material-symbols-outlined text-xl ${theme.icon}`}>{note.noteIcon || 'push_pin'}</span>
                                                </div>
                                                <div className="flex flex-col gap-0.5 text-left">
                                                    <p className={`text-[0.6rem] font-sans font-bold uppercase tracking-[0.2em] ${theme.label}`}>{note.labels && note.labels[0] ? note.labels[0] : 'LABEL'}</p>
                                                    <p className={`text-xl font-bold tracking-tight ${theme.text}`}>{note.title || "Untitled"}</p>
                                                </div>
                                            </div>
                                        );
                                    })}

                                    {/* Add New Reminder Card */}
                                    <button 
                                        onClick={onOpenCreator}
                                        className="sticky-note-add aspect-square border-2 border-dashed border-primary/40 rounded-2xl p-6 flex flex-col items-center justify-center group cursor-pointer hover:bg-primary/5 transition-colors"
                                    >
                                        <div className="w-10 h-10 rounded-full bg-primary/10 flex items-center justify-center text-primary mb-3">
                                            <span className="material-symbols-outlined text-2xl">add</span>
                                        </div>
                                        <p className="text-sm font-bold text-primary/80 uppercase tracking-widest text-center px-2">Add New Reminder</p>
                                    </button>
                                </div>
                            )}
                        </section>
                        <section className="grid grid-cols-1 lg:grid-cols-3 gap-12 mb-32">
                            <div className="lg:col-span-2 space-y-6">
                                <div className="glass-panel rounded-3xl p-8 flex items-center justify-between group hover:bg-white/5 transition-colors cursor-pointer">
                                    <div className="flex items-center gap-6">
                                        <div className="w-12 h-12 rounded-full border border-primary/40 flex items-center justify-center text-primary">
                                            <span className="material-symbols-outlined">circle</span>
                                        </div>
                                        <div>
                                            <h4 className="text-xl text-cream-light font-medium">Finalize project proposal</h4>
                                            <p className="text-cream-light/40 text-sm font-sans mt-1">Due Today  Priority 3A</p>
                                        </div>
                                    </div>
                                    <span className="material-symbols-outlined text-cream-light/20 group-hover:text-primary transition-colors">chevron_right</span>
                                </div>
                                <div className="glass-panel rounded-3xl p-8 flex items-center justify-between group hover:bg-white/5 transition-colors cursor-pointer">
                                    <div className="flex items-center gap-6">
                                        <div className="w-12 h-12 rounded-full border border-white/10 flex items-center justify-center text-cream-light/20">
                                            <span className="material-symbols-outlined">circle</span>
                                        </div>
                                        <div>
                                            <h4 className="text-xl text-cream-light font-medium">Weekly meal prep</h4>
                                            <p className="text-cream-light/40 text-sm font-sans mt-1">Due Tomorrow  Chores</p>
                                        </div>
                                    </div>
                                    <span className="material-symbols-outlined text-cream-light/20 group-hover:text-primary transition-colors">chevron_right</span>
                                </div>
                            </div>
                            <div className="glass-panel rounded-3xl p-10 flex flex-col items-center justify-center text-center space-y-6">
                                <div className="w-20 h-20 bg-primary/10 rounded-full flex items-center justify-center text-primary mb-2">
                                    <span className="material-symbols-outlined text-4xl" style={{fontVariationSettings: '"FILL" 1'}}>bolt</span>
                                </div>
                                <h3 className="text-2xl font-bold text-cream-light">Quick Focus</h3>
                                <p className="text-cream-light/60 font-sans leading-relaxed">Start a 25-minute pomodoro session to breeze through your tasks.</p>
                                <button className="w-full bg-primary/20 hover:bg-primary/30 text-primary border border-primary/30 py-4 rounded-2xl font-bold transition-all uppercase tracking-widest text-xs">Start Session</button>
                            </div>
                        </section>
                    </div>
                </Layout>
            );
        };

        const NotesPage = ({ user, notes, onOpenCreator, onEditNote, noteSections, onAddSection, onDeleteSection, onMoveNote }) => {
            const pinnedNotes = notes.filter(n => n.isPinned);
            const [labelFilter, setLabelFilter] = useState('');
            const [showLabelDropdown, setShowLabelDropdown] = useState(false);
            const [showAddSection, setShowAddSection] = useState(false);
            const [newSectionName, setNewSectionName] = useState('');
            const [contextMenu, setContextMenu] = useState(null); // { noteId, x, y }
            const longPressTimer = useRef(null);
            const dropdownRef = useRef(null);

            // Collect all unique labels
            const allLabels = useMemo(() => {
                const set = new Set();
                notes.forEach(n => (n.labels || []).forEach(l => set.add(l)));
                return Array.from(set).sort();
            }, [notes]);

            // Filter function
            const matchesFilter = (note) => {
                if (!labelFilter) return true;
                return (note.labels || []).includes(labelFilter);
            };

            // Group notes by section (excluding pinned)
            const unpinnedNotes = notes.filter(n => !n.isPinned);
            const sectionNotes = (sectionName) => unpinnedNotes.filter(n => (n.section || '') === sectionName && matchesFilter(n));
            const allNotesUnsectioned = unpinnedNotes.filter(n => !n.section && matchesFilter(n));

            // Close dropdown on outside click
            useEffect(() => {
                const handler = (e) => {
                    if (dropdownRef.current && !dropdownRef.current.contains(e.target)) setShowLabelDropdown(false);
                };
                document.addEventListener('mousedown', handler);
                return () => document.removeEventListener('mousedown', handler);
            }, []);

            // Close context menu on click anywhere
            useEffect(() => {
                if (!contextMenu) return;
                const handler = () => setContextMenu(null);
                document.addEventListener('mousedown', handler);
                document.addEventListener('touchstart', handler);
                return () => { document.removeEventListener('mousedown', handler); document.removeEventListener('touchstart', handler); };
            }, [contextMenu]);

            // Long press handlers
            const startLongPress = (noteId, e) => {
                const clientX = e.touches ? e.touches[0].clientX : e.clientX;
                const clientY = e.touches ? e.touches[0].clientY : e.clientY;
                longPressTimer.current = setTimeout(() => {
                    setContextMenu({ noteId, x: clientX, y: clientY });
                }, 500);
            };
            const cancelLongPress = () => {
                if (longPressTimer.current) clearTimeout(longPressTimer.current);
            };

            const handleAddSectionSubmit = () => {
                if (newSectionName.trim()) {
                    onAddSection(newSectionName);
                    setNewSectionName('');
                    setShowAddSection(false);
                }
            };

            // Render a note grid with long-press support
            const renderNoteGrid = (notesList, gridClass = "grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-8") => (
                <div className={gridClass}>
                    {notesList.map((note, index) => (
                        <div 
                            key={note.id}
                            onMouseDown={(e) => startLongPress(note.id, e)}
                            onMouseUp={cancelLongPress}
                            onMouseLeave={cancelLongPress}
                            onTouchStart={(e) => startLongPress(note.id, e)}
                            onTouchEnd={cancelLongPress}
                            onTouchMove={cancelLongPress}
                        >
                            <NoteCard note={note} onClick={() => onEditNote(note)} index={index} />
                        </div>
                    ))}
                </div>
            );

            // Label filter dropdown component
            const LabelFilterDropdown = () => (
                <div className="relative" ref={dropdownRef}>
                    <button 
                        onClick={() => setShowLabelDropdown(!showLabelDropdown)}
                        className={"inline-flex items-center gap-1.5 text-[10px] font-bold uppercase tracking-widest px-3 py-1.5 rounded-lg border transition-all " + (labelFilter ? "bg-primary/20 text-primary border-primary/30" : "text-cream-light/40 border-white/10 hover:border-white/20 hover:text-cream-light/60")}
                    >
                        <span className="material-symbols-outlined text-xs">filter_list</span>
                        {labelFilter || 'Filter'}
                        {labelFilter && (
                            <button onClick={(e) => { e.stopPropagation(); setLabelFilter(''); setShowLabelDropdown(false); }} className="ml-1 hover:text-primary-dark">
                                <span className="material-symbols-outlined text-xs">close</span>
                            </button>
                        )}
                    </button>
                    {showLabelDropdown && (
                        <div className="absolute right-0 top-full mt-2 w-48 glass-panel rounded-xl border border-white/10 shadow-2xl z-50 py-2 overflow-hidden">
                            <button 
                                onClick={() => { setLabelFilter(''); setShowLabelDropdown(false); }}
                                className={"w-full text-left px-4 py-2 text-xs font-bold transition-colors " + (!labelFilter ? "text-primary bg-primary/10" : "text-cream-light/60 hover:bg-white/5 hover:text-cream-light")}
                            >All Labels</button>
                            {allLabels.map(label => (
                                <button 
                                    key={label}
                                    onClick={() => { setLabelFilter(label); setShowLabelDropdown(false); }}
                                    className={"w-full text-left px-4 py-2 text-xs font-bold uppercase tracking-wider transition-colors " + (labelFilter === label ? "text-primary bg-primary/10" : "text-cream-light/60 hover:bg-white/5 hover:text-cream-light")}
                                >{label}</button>
                            ))}
                            {allLabels.length === 0 && (
                                <p className="px-4 py-2 text-xs text-white/20">No labels yet</p>
                            )}
                        </div>
                    )}
                </div>
            );

            return (
                <Layout onOpenCreator={onOpenCreator}>
                    <div className="max-w-7xl mx-auto w-full px-6 md:px-16 pt-0 md:pt-16 pb-12">
                        <Header user={user} />

                        {/* Pinned Section */}
                        {pinnedNotes.length > 0 && (
                            <section className="mb-12">
                                <div className="flex items-center gap-4 mb-8">
                                    <span className="material-symbols-outlined text-primary/60 text-lg" style={{fontVariationSettings: "'FILL' 1"}}>push_pin</span>
                                    <h2 className="text-sm font-bold text-cream-light/90 uppercase tracking-[0.3em]">PINNED</h2>
                                    <div className="h-[1px] flex-1 bg-gradient-to-r from-primary/30 to-transparent"></div>
                                </div>
                                {renderNoteGrid(pinnedNotes.filter(matchesFilter))}
                            </section>
                        )}

                        {/* Custom Sections */}
                        {(noteSections || []).map(sectionName => {
                            const sNotes = sectionNotes(sectionName);
                            return (
                                <section key={sectionName} className="mb-12">
                                    <div className="flex items-center gap-4 mb-8">
                                        <span className="material-symbols-outlined text-primary/60 text-lg">folder</span>
                                        <h2 className="text-sm font-bold text-cream-light/90 uppercase tracking-[0.3em]">{sectionName}</h2>
                                        <div className="h-[1px] flex-1 bg-gradient-to-r from-primary/30 to-transparent"></div>
                                        <button onClick={() => onDeleteSection(sectionName)} className="text-white/20 hover:text-red-400 transition-colors" title="Delete section">
                                            <span className="material-symbols-outlined text-sm">delete</span>
                                        </button>
                                    </div>
                                    {sNotes.length > 0 ? renderNoteGrid(sNotes) : (
                                        <div className="flex flex-col items-center justify-center py-10 text-center border border-dashed border-white/5 rounded-2xl">
                                            <span className="material-symbols-outlined text-3xl text-white/5 mb-2">note_stack</span>
                                            <p className="text-white/20 text-xs">Long-press a note to move it here</p>
                                        </div>
                                    )}
                                </section>
                            );
                        })}

                        {/* Add Section Button */}
                        <div className="mb-8">
                            {showAddSection ? (
                                <div className="flex items-center gap-3">
                                    <input 
                                        type="text" 
                                        value={newSectionName} 
                                        onChange={(e) => setNewSectionName(e.target.value)}
                                        onKeyDown={(e) => e.key === 'Enter' && handleAddSectionSubmit()}
                                        placeholder="Section name..."
                                        className="bg-white/5 border border-white/10 rounded-xl px-4 py-2 text-sm text-cream-light placeholder:text-white/20 focus:outline-none focus:border-primary/40 font-montserrat uppercase tracking-widest"
                                        autoFocus
                                    />
                                    <button onClick={handleAddSectionSubmit} className="p-2 text-primary hover:bg-primary/10 rounded-lg transition-colors">
                                        <span className="material-symbols-outlined text-lg">check</span>
                                    </button>
                                    <button onClick={() => { setShowAddSection(false); setNewSectionName(''); }} className="p-2 text-white/30 hover:text-white/60 rounded-lg transition-colors">
                                        <span className="material-symbols-outlined text-lg">close</span>
                                    </button>
                                </div>
                            ) : (
                                <button onClick={() => setShowAddSection(true)} className="inline-flex items-center gap-2 text-[10px] font-bold text-primary/40 uppercase tracking-widest hover:text-primary/70 transition-colors">
                                    <span className="material-symbols-outlined text-sm">add</span>
                                    Add Section
                                </button>
                            )}
                        </div>

                        {/* All Notes Section (always at bottom) */}
                        <section className="mb-10">
                            <div className="flex items-center gap-4 mb-8">
                                <h2 className="text-sm font-bold text-cream-light/90 uppercase tracking-[0.3em]">ALL NOTES</h2>
                                <div className="h-[1px] flex-1 bg-gradient-to-r from-primary/30 to-transparent"></div>
                                <LabelFilterDropdown />
                            </div>
                            {allNotesUnsectioned.length > 0 ? (
                                <div className="pb-32">
                                    {renderNoteGrid(allNotesUnsectioned)}
                                </div>
                            ) : (
                                <div className="flex flex-col items-center justify-center py-16 text-center">
                                    <span className="material-symbols-outlined text-5xl text-white/5 mb-3">note_stack</span>
                                    <p className="text-white/30 text-sm">{labelFilter ? 'No notes match this filter' : 'No notes here'}</p>
                                </div>
                            )}
                        </section>
                    </div>

                    {/* Long-press context menu */}
                    {contextMenu && (
                        <div 
                            className="fixed z-[200] glass-panel rounded-xl border border-white/10 shadow-2xl py-2 w-52 animate-in fade-in zoom-in-95 duration-150"
                            style={{ left: Math.min(contextMenu.x, window.innerWidth - 220), top: Math.min(contextMenu.y, window.innerHeight - 200) }}
                            onMouseDown={(e) => e.stopPropagation()}
                            onTouchStart={(e) => e.stopPropagation()}
                        >
                            <p className="px-4 py-1.5 text-[9px] font-bold text-white/30 uppercase tracking-widest">Move to</p>
                            <button 
                                onClick={() => { onMoveNote(contextMenu.noteId, ''); setContextMenu(null); }}
                                className="w-full text-left px-4 py-2.5 text-xs font-semibold text-cream-light/70 hover:bg-white/5 hover:text-cream-light transition-colors flex items-center gap-2"
                            >
                                <span className="material-symbols-outlined text-sm text-primary/60">notes</span>
                                All Notes
                            </button>
                            {(noteSections || []).map(sec => (
                                <button 
                                    key={sec}
                                    onClick={() => { onMoveNote(contextMenu.noteId, sec); setContextMenu(null); }}
                                    className="w-full text-left px-4 py-2.5 text-xs font-semibold text-cream-light/70 hover:bg-white/5 hover:text-cream-light transition-colors flex items-center gap-2"
                                >
                                    <span className="material-symbols-outlined text-sm text-primary/60">folder</span>
                                    {sec}
                                </button>
                            ))}
                        </div>
                    )}
                </Layout>
            );
        };

        const CalendarPage = ({ user, notes, onOpenCreator, onEditNote }) => {
            const [currentDate, setCurrentDate] = useState(new Date());
            const [selectedDate, setSelectedDate] = useState(new Date());
            const today = new Date();

            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            const monthName = currentDate.toLocaleString('en-US', { month: 'long' });
            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const prevMonthDays = new Date(year, month, 0).getDate();

            const prevMonth = () => setCurrentDate(new Date(year, month - 1, 1));
            const nextMonth = () => setCurrentDate(new Date(year, month + 1, 1));
            const goToday = () => { setCurrentDate(new Date()); setSelectedDate(new Date()); };

            const isToday = (d) => d === today.getDate() && month === today.getMonth() && year === today.getFullYear();
            const isSelected = (d) => d === selectedDate.getDate() && month === selectedDate.getMonth() && year === selectedDate.getFullYear();

            // Build reminder lookup: date string -> notes array
            const remindersByDate = useMemo(() => {
                const map = {};
                (notes || []).forEach(note => {
                    if (!note.reminderDate) return;
                    try {
                        const d = new Date(note.reminderDate);
                        const key = `${d.getFullYear()}-${d.getMonth()}-${d.getDate()}`;
                        if (!map[key]) map[key] = [];
                        map[key].push(note);
                    } catch(e) {}
                });
                return map;
            }, [notes]);

            const getRemindersForDay = (day) => {
                const key = `${year}-${month}-${day}`;
                return remindersByDate[key] || [];
            };

            const selectedDayLabel = selectedDate.toLocaleString('en-US', { weekday: 'long', month: 'short', day: 'numeric' });
            const dayReminders = getRemindersForDay(selectedDate.getDate());

            // Upcoming reminders (from today onwards)
            const upcomingReminders = useMemo(() => {
                const now = new Date();
                now.setHours(0, 0, 0, 0);
                return (notes || [])
                    .filter(n => n.reminderDate && new Date(n.reminderDate) >= now)
                    .sort((a, b) => new Date(a.reminderDate) - new Date(b.reminderDate))
                    .slice(0, 8);
            }, [notes]);

            // Build calendar grid cells
            const cells = [];
            // Previous month trailing days
            for (let i = firstDay - 1; i >= 0; i--) {
                cells.push({ day: prevMonthDays - i, current: false });
            }
            // Current month days
            for (let d = 1; d <= daysInMonth; d++) {
                cells.push({ day: d, current: true });
            }
            // Next month leading days
            const remaining = 7 - (cells.length % 7);
            if (remaining < 7) {
                for (let i = 1; i <= remaining; i++) {
                    cells.push({ day: i, current: false });
                }
            }

            return (
                <Layout onOpenCreator={onOpenCreator}>
                    <div className="flex-1 flex flex-col md:flex-row h-full">
                        <div className="flex-1 overflow-y-auto no-scrollbar px-6 md:px-10 pt-0 md:pt-8 pb-8">
                            <Header user={user} />
                            <div className="flex items-center justify-between mb-6">
                                <div className="flex items-center gap-4">
                                    <h2 className="text-2xl font-display font-bold text-cream-light italic">{monthName} {year}</h2>
                                    <div className="flex gap-1.5">
                                        <button onClick={prevMonth} className="p-1.5 glass-panel rounded-full text-cream-light/60 hover:text-primary transition-colors"><span className="material-symbols-outlined text-lg">chevron_left</span></button>
                                        <button onClick={nextMonth} className="p-1.5 glass-panel rounded-full text-cream-light/60 hover:text-primary transition-colors"><span className="material-symbols-outlined text-lg">chevron_right</span></button>
                                    </div>
                                    <button onClick={goToday} className="text-[9px] font-bold text-primary/60 uppercase tracking-widest hover:text-primary transition-colors ml-2">Today</button>
                                </div>
                            </div>
                            <div className="glass-panel rounded-2xl overflow-hidden border-white/5 shadow-2xl">
                                <div className="grid grid-cols-7 bg-white/5 text-center border-b border-white/5 py-2.5">
                                    {['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'].map(day => (
                                        <div key={day} className="text-[9px] font-bold text-primary/60 uppercase tracking-widest">{day}</div>
                                    ))}
                                </div>
                                <div className="grid grid-cols-7">
                                    {cells.map((cell, i) => {
                                        const reminders = cell.current ? getRemindersForDay(cell.day) : [];
                                        const todayMatch = cell.current && isToday(cell.day);
                                        const selectedMatch = cell.current && isSelected(cell.day);
                                        return (
                                            <div 
                                                key={i} 
                                                onClick={() => cell.current && setSelectedDate(new Date(year, month, cell.day))}
                                                className={`border-r border-b border-white/5 p-2.5 min-h-[70px] relative transition-colors cursor-pointer ${cell.current ? 'hover:bg-white/5' : 'opacity-25'} ${todayMatch ? 'bg-primary/10' : ''} ${selectedMatch && !todayMatch ? 'bg-white/5' : ''}`}
                                            >
                                                <span className={`text-xs font-sans ${todayMatch ? 'font-bold text-primary' : ''} ${selectedMatch && !todayMatch ? 'font-semibold text-cream-light' : ''}`}>{cell.day}</span>
                                                {todayMatch && <div className="absolute top-2.5 right-2.5 w-1.5 h-1.5 rounded-full bg-primary glow-orange"></div>}
                                                {reminders.length > 0 && (
                                                    <div className="flex flex-wrap gap-0.5 mt-1">
                                                        {reminders.slice(0, 2).map((r, ri) => (
                                                            <div key={ri} className="w-full truncate text-[8px] font-bold text-primary/80 bg-primary/10 rounded px-1 py-0.5">{r.title || 'Reminder'}</div>
                                                        ))}
                                                        {reminders.length > 2 && <span className="text-[8px] text-primary/50 font-bold">+{reminders.length - 2}</span>}
                                                    </div>
                                                )}
                                            </div>
                                        );
                                    })}
                                </div>
                            </div>
                        </div>
                        <aside className="w-full md:w-80 border-l border-white/5 bg-black/20 backdrop-blur-md p-6 overflow-y-auto no-scrollbar">
                            <div className="mb-6">
                                <div className="flex items-center gap-3 mb-1.5">
                                    <h3 className="text-xl font-display font-bold text-cream-light italic">Daily Agenda</h3>
                                    <div className="h-px flex-1 bg-gradient-to-r from-primary/30 to-transparent"></div>
                                </div>
                                <p className="text-cream-light/40 text-[10px] font-sans uppercase tracking-[0.2em] font-bold">{selectedDayLabel}</p>
                            </div>
                            {dayReminders.length > 0 ? (
                                <div className="space-y-3 mb-8">
                                    {dayReminders.map((note, idx) => (
                                        <div key={idx} onClick={() => onEditNote && onEditNote(note)} className="card-glow bg-orange-100/90 rounded-xl p-4 border-b-3 border-orange-300/50 cursor-pointer hover:scale-[1.02] transition-transform">
                                            <h4 className="text-sm font-bold text-orange-950/80 leading-tight">{note.title || 'Untitled'}</h4>
                                            <p className="text-[10px] text-orange-900/60 mt-1 font-sans">{formatReminderDate(note.reminderDate)}{note.labels && note.labels[0] ? `  ${note.labels[0]}` : ''}</p>
                                        </div>
                                    ))}
                                </div>
                            ) : (
                                <div className="text-center py-8 mb-8">
                                    <span className="material-symbols-outlined text-3xl text-white/5 mb-2">event_available</span>
                                    <p className="text-white/20 text-xs font-sans">No reminders this day</p>
                                </div>
                            )}
                            {upcomingReminders.length > 0 && (
                                <div>
                                    <div className="flex items-center gap-3 mb-4">
                                        <h4 className="text-xs font-bold text-cream-light/60 uppercase tracking-[0.2em]">Upcoming</h4>
                                        <div className="h-px flex-1 bg-gradient-to-r from-primary/20 to-transparent"></div>
                                    </div>
                                    <div className="space-y-2.5">
                                        {upcomingReminders.map((note, idx) => (
                                            <div key={idx} onClick={() => onEditNote && onEditNote(note)} className="flex items-start gap-3 p-3 rounded-xl hover:bg-white/5 transition-colors cursor-pointer group">
                                                <div className="w-2 h-2 rounded-full bg-primary mt-1.5 flex-shrink-0"></div>
                                                <div className="flex-1 min-w-0">
                                                    <p className="text-xs font-semibold text-cream-light/80 truncate">{note.title || 'Untitled'}</p>
                                                    <p className="text-[9px] text-cream-light/30 font-sans mt-0.5">{formatReminderDate(note.reminderDate)}</p>
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            )}
                        </aside>
                    </div>
                </Layout>
            );
        };

        const StatsPage = ({ user, onOpenCreator }) => (
            <Layout onOpenCreator={onOpenCreator}>
                <div className="max-w-7xl mx-auto w-full px-6 md:px-12 pt-0 md:pt-10 pb-32">
                    <Header user={user} subtitle="Productivity Statistics" />
                    <div className="grid grid-cols-1 lg:grid-cols-12 gap-8">
                        <div className="lg:col-span-4 glass-panel rounded-3xl p-8 flex flex-col items-center justify-center card-glow">
                            <h3 className="text-xl font-display font-bold text-cream-light italic mb-8 w-full">Overall Progress</h3>
                            <div className="relative w-56 h-56 flex items-center justify-center">
                                <svg className="w-full h-full -rotate-90" viewBox="0 0 100 100">
                                    <circle cx="50" cy="50" fill="transparent" r="42" stroke="rgba(255,255,255,0.05)" strokeWidth="8"></circle>
                                    <circle cx="50" cy="50" fill="transparent" r="42" stroke="#f97316" strokeDasharray="211 264" strokeLinecap="round" strokeWidth="8"></circle>
                                </svg>
                                <div className="absolute inset-0 flex flex-col items-center justify-center">
                                    <span className="text-4xl font-display font-bold text-cream-light">80%</span>
                                    <span className="text-[10px] font-bold text-primary/60 uppercase tracking-widest mt-1">Completed</span>
                                </div>
                            </div>
                        </div>
                        <div className="lg:col-span-8 glass-panel rounded-3xl p-8 card-glow">
                            <h3 className="text-xl font-display font-bold text-cream-light italic mb-8">Completion per List</h3>
                            <div className="space-y-8">
                                <div className="space-y-2">
                                    <div className="flex justify-between text-xs font-sans font-medium text-cream-light/60"><span>Priority 3A</span><span>92%</span></div>
                                    <div className="w-full h-2 bg-white/5 rounded-full overflow-hidden">
                                        <div className="h-full bg-pastel-orange rounded-full" style={{width: '92%'}}></div>
                                    </div>
                                </div>
                                <div className="space-y-2">
                                    <div className="flex justify-between text-xs font-sans font-medium text-cream-light/60"><span>Errands</span><span>75%</span></div>
                                    <div className="w-full h-2 bg-white/5 rounded-full overflow-hidden">
                                        <div className="h-full bg-pastel-peach rounded-full" style={{width: '75%'}}></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </Layout>
        );

        const StreakPage = ({ user, onOpenCreator }) => (
            <Layout onOpenCreator={onOpenCreator}>
                <div className="max-w-7xl mx-auto w-full px-8 md:px-16 pt-0 md:pt-12 pb-12">
                    <Header user={user} subtitle="Streak & Achievements" />
                    <section className="mb-16 flex flex-col items-center text-center">
                        <div className="relative mb-6">
                            <span className="material-symbols-outlined text-[120px] text-primary glow-orange leading-none relative z-10" style={{fontVariationSettings: "'FILL' 1"}}>local_fire_department</span>
                        </div>
                        <h2 className="text-8xl font-black text-primary italic glow-orange tracking-tighter mb-2">12 DAYS</h2>
                        <p className="text-cream-light/40 text-lg uppercase tracking-[0.5em] font-sans font-bold">Current Streak</p>
                    </section>
                    <section className="grid grid-cols-1 md:grid-cols-3 gap-6 mb-20">
                        <div className="glass-panel card-glow rounded-3xl p-8 flex flex-col items-center text-center gap-4">
                            <div className="w-16 h-16 rounded-full bg-amber-400/10 flex items-center justify-center text-amber-400 border border-amber-400/30">
                                <span className="material-symbols-outlined text-3xl" style={{fontVariationSettings: "'FILL' 1"}}>light_mode</span>
                            </div>
                            <h3 className="text-xl font-bold text-cream-light">Early Bird</h3>
                            <p className="text-cream-light/40 text-sm font-sans">Completed 5 tasks before 8AM</p>
                        </div>
                        {/* More badges can go here */}
                    </section>
                </div>
            </Layout>
        );

        const ClockPage = ({ user, onOpenCreator }) => (
            <Layout onOpenCreator={onOpenCreator}>
                <div className="max-w-7xl mx-auto w-full px-8 md:px-16 pt-0 md:pt-12 pb-12">
                    <Header user={user} subtitle="Clock & Notifications" />
                    <div className="grid grid-cols-1 lg:grid-cols-2 gap-16 items-center min-h-[500px]">
                        <div className="flex flex-col items-center justify-center space-y-12">
                            <div className="analog-clock flex items-center justify-center">
                                <div className="absolute w-[2px] h-[108px] bg-white origin-bottom rotate-[190deg] rounded-full bottom-[50%]"></div>
                                <div className="absolute w-[4px] h-[72px] bg-white origin-bottom rotate-[45deg] rounded-full bottom-[50%]"></div>
                                <div className="absolute w-[1px] h-[117px] bg-primary origin-bottom rotate-[310deg] rounded-full bottom-[50%] glow-orange"></div>
                                <div className="w-3 h-3 bg-primary border-2 border-white rounded-full z-10"></div>
                            </div>
                            <div className="text-center">
                                <h2 className="text-6xl font-display text-cream-light mb-2">10:08</h2>
                                <p className="text-primary/60 font-sans tracking-[0.5em] uppercase text-sm font-bold">Monday, Oct 23</p>
                            </div>
                        </div>
                        <div className="space-y-4">
                            <h2 className="text-2xl font-bold text-cream-light/90 uppercase tracking-[0.3em] mb-4">Notifications</h2>
                            <div className="glass-panel p-6 rounded-3xl flex gap-5 border-l-4 border-l-orange-500 hover:bg-white/5 transition-all cursor-pointer">
                                <div className="w-12 h-12 rounded-2xl bg-orange-500/10 flex items-center justify-center text-orange-500 shrink-0">
                                    <span className="material-symbols-outlined">priority_high</span>
                                </div>
                                <div className="flex-1">
                                    <h4 className="font-bold text-cream-light">Task Deadline Reached</h4>
                                    <p className="text-sm text-cream-light/60 font-sans mt-1">The project proposal deadline has passed.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </Layout>
        );

        const LoadingPage = ({ onComplete }) => {
            useEffect(() => {
                const timer = setTimeout(onComplete, 1000);
                return () => clearTimeout(timer);
            }, [onComplete]);

            return (
                <div className="fixed inset-0 z-50 blur-overlay flex flex-col items-center justify-center">
                    <div className="loading-arc-container relative flex items-center justify-center w-[252px] h-[252px]">
                        <div className="loading-arc"></div>
                        <div className="absolute flex flex-col items-center text-center z-10">
                            <div className="relative">
                                <div className="flame-container">
                                    {[...Array(5)].map((_, i) => (
                                        <div key={i} className="flame-tongue" style={{animationDelay: (i * 0.15) + "s"}}></div>
                                    ))}
                                </div>
                                <h1 className="text-7xl font-bold tracking-tight text-cream-light italic leading-none drop-shadow-[0_0_30px_rgba(249,115,22,0.4)]">
                                    Faiora
                                </h1>
                            </div>
                            <div className="mt-8">
                                <p className="text-primary text-[10px] uppercase tracking-[0.8em] font-sans font-bold">Fallo ora</p>
                            </div>
                        </div>
                    </div>
                    <div className="absolute bottom-24 w-full px-12 max-w-md">
                        <div className="flex justify-between items-end mb-4 px-1">
                            <span className="text-[10px] font-sans font-medium uppercase tracking-[0.2em] text-white/40">Awakening Systems</span>
                            <span className="text-xs font-sans font-bold text-primary tracking-tighter">100%</span>
                        </div>
                        <div className="relative h-[4px] w-full bg-white/5 rounded-full overflow-hidden">
                            <div className="absolute top-0 left-0 h-full bg-primary w-full rounded-full transition-all duration-[2000ms] ease-out"></div>
                        </div>
                    </div>
                </div>
            );
        };

        // --- Root Component ---
        


        const TransitionManager = ({ children }) => {
            const location = useLocation();
            const [displayLocation, setDisplayLocation] = useState(location);
            const [isWiping, setIsWiping] = useState(false);
            const [isDissolving, setIsDissolving] = useState(false);
            const [transitionKey, setTransitionKey] = useState(0);

            const playFireSFX = () => {
                const audio = new Audio('fire_transition_sfx.mp3');
                audio.volume = 0.4;
                audio.play().catch(e => {
                    // Silent catch for autoplay restrictions
                });
                
                // Fade out after 1 second
                setTimeout(() => {
                    const fadeDuration = 500; // 0.5s fade
                    const step = 0.05;
                    const interval = fadeDuration / (0.4 / step);
                    
                    const fadeInterval = setInterval(() => {
                        if (audio.volume > step) {
                            audio.volume -= step;
                        } else {
                            audio.volume = 0;
                            clearInterval(fadeInterval);
                            audio.pause();
                        }
                    }, interval);
                }, 1000);
            };

            useEffect(() => {
                // Trigger wipe on initial mount (post-loader)
                setIsWiping(true);
                setIsDissolving(true);
                setTransitionKey(prev => prev + 1);
                
                playFireSFX();
                
                const swapTimer = setTimeout(() => {
                    setIsDissolving(false);
                }, 900);

                const doneTimer = setTimeout(() => {
                    setIsWiping(false);
                }, 2000);

                return () => {
                    clearTimeout(swapTimer);
                    clearTimeout(doneTimer);
                };
            }, []);

            useEffect(() => {
                if (location.pathname !== displayLocation.pathname) {
                    setIsWiping(true);
                    setIsDissolving(true);
                    setTransitionKey(prev => prev + 1);

                    playFireSFX();
                    
                    // MIDPOINT: Swap content when fire covers screen
                    const swapTimer = setTimeout(() => {
                        setDisplayLocation(location);
                        setIsDissolving(false);
                    }, 900);

                    // END: Cleanup wipe
                    const doneTimer = setTimeout(() => {
                        setIsWiping(false);
                    }, 2000);

                    return () => {
                        clearTimeout(swapTimer);
                        clearTimeout(doneTimer);
                    };
                }
            }, [location, displayLocation]);

            return (
                <div className="relative w-full h-full overflow-hidden">
                    {isWiping && (
                        <div key={transitionKey} className="fire-wipe-overlay fire-wipe-active">
                            <div className="fire-wipe-sprite"></div>
                        </div>
                    )}
                    <div key={displayLocation.pathname} className={`w-full h-full transition-all duration-300 ${isDissolving ? 'dissolve-out' : 'dissolve-in'}`}>
                        <Routes location={displayLocation}>
                            {children}
                        </Routes>
                        {/* Fallback invisibility safety: If somehow stuck in dissolve-out for more than 5s, force dissolve-in via inline style if needed, 
                            but better to ensure isDissolving state is reliable */}
                    </div>
                </div>
            );
        };

        const App = () => {
            const [isTimerDone, setIsTimerDone] = useState(false);
            const [isAuthChecked, setIsAuthChecked] = useState(false);
            const [activeCollection, setActiveCollection] = useState('tasks');
            const [isCreatorOpen, setIsCreatorOpen] = useState(false);
            const [editingNote, setEditingNote] = useState(null);
            const [user, setUser] = useState(null);
            const [notes, setNotes] = useState([]);
            const [noteSections, setNoteSections] = useState(() => {
                try { return JSON.parse(localStorage.getItem('faiora_sections') || '[]'); } catch(e) { return []; }
            });
            const [toasts, setToasts] = useState([]);
            const videoRef = useRef();

            const showToast = useCallback((message) => {
                const id = Date.now();
                setToasts(prev => [...prev, { id, message }]);
                setTimeout(() => {
                    setToasts(prev => prev.filter(t => t.id !== id));
                }, 3000);
            }, []);

            // Centralized loading and syncing
            useEffect(() => {
                if (!user || !activeCollection) return;

                // 1. Initial Load from LocalStorage (Instant)
                const lsKey = 'faiora_notes_' + user.uid;
                try {
                    const localData = JSON.parse(localStorage.getItem(lsKey) || '[]');
                    setNotes(localData);
                } catch(e) { console.warn("LocalStorage load fail", e); }

                // 2. Active Sync from Firestore (Background)
                const unsubscribe = db.collection(activeCollection).doc(user.uid).onSnapshot(doc => {
                    if (doc.exists) {
                        const data = doc.data();
                        const fetchedNotesMap = data && data.notes ? data.notes : {};
                        const fetchedNotes = Object.values(fetchedNotesMap);
                        
                        // Centralized Sorting
                        fetchedNotes.sort((a, b) => {
                            if (a.isPinned && !b.isPinned) return -1;
                            if (!a.isPinned && b.isPinned) return 1;
                            const timeA = a.updatedAt ? (a.updatedAt.toMillis ? a.updatedAt.toMillis() : new Date(a.updatedAt).getTime()) : 0;
                            const timeB = b.updatedAt ? (b.updatedAt.toMillis ? b.updatedAt.toMillis() : new Date(b.updatedAt).getTime()) : 0;
                            return timeB - timeA;
                        });

                        setNotes(fetchedNotes);
                        localStorage.setItem('faiora_notes_' + user.uid, JSON.stringify(fetchedNotes));
                        console.log("App synced with cloud:", fetchedNotes.length, "notes");
                    }
                }, err => {
                    if (err.code !== 'permission-denied') console.warn("Firestore sync error", err);
                });

                return () => unsubscribe();
            }, [user, activeCollection]);

            const handleUpdateNoteLocal = (updatedNote) => {
                setNotes(prev => {
                    const idx = prev.findIndex(n => n.id === updatedNote.id);
                    const newNotes = [...prev];
                    if (idx > -1) newNotes[idx] = updatedNote;
                    else newNotes.push(updatedNote);
                    
                    // Re-sort immediately
                    newNotes.sort((a, b) => {
                        if (a.isPinned && !b.isPinned) return -1;
                        if (!a.isPinned && b.isPinned) return 1;
                        const timeA = new Date(a.updatedAt).getTime();
                        const timeB = new Date(b.updatedAt).getTime();
                        return timeB - timeA;
                    });

                    if (user) {
                        localStorage.setItem('faiora_notes_' + user.uid, JSON.stringify(newNotes));
                    }
                    return newNotes;
                });
            };

            const handleDeleteNoteLocal = (noteId) => {
                setNotes(prev => {
                    const newNotes = prev.filter(n => n.id !== noteId);
                    if (user) {
                        localStorage.setItem('faiora_notes_' + user.uid, JSON.stringify(newNotes));
                    }
                    return newNotes;
                });
            };

            const handleRestoreDefaults = () => {
                if (!user || !activeCollection) return;
                const sampleNote = { 
                    id: 'note_welcome', 
                    title: 'Welcome to Faiora', 
                    labels: ['GETTING STARTED'], 
                    noteIcon: 'auto_stories', 
                    noteTheme: 'peach', 
                    content: '<div>Welcome! This is your first note. Click to edit, or use the + button to create a new one.</div>' 
                };
                const notesMap = {
                    [sampleNote.id]: { ...sampleNote, updatedAt: firebase.firestore.FieldValue.serverTimestamp() }
                };
                db.collection(activeCollection).doc(user.uid).set({ notes: notesMap }, { merge: true })
                    .catch(e => console.error("Error restoring defaults:", e));
            };

            const handleAddSection = (name) => {
                if (!name.trim() || noteSections.includes(name.trim().toUpperCase())) return;
                const updated = [...noteSections, name.trim().toUpperCase()];
                setNoteSections(updated);
                localStorage.setItem('faiora_sections', JSON.stringify(updated));
            };

            const handleDeleteSection = (name) => {
                const updated = noteSections.filter(s => s !== name);
                setNoteSections(updated);
                localStorage.setItem('faiora_sections', JSON.stringify(updated));
                // Move notes from deleted section back to ALL NOTES
                setNotes(prev => {
                    const newNotes = prev.map(n => n.section === name ? { ...n, section: '' } : n);
                    if (user) localStorage.setItem('faiora_notes_' + user.uid, JSON.stringify(newNotes));
                    return newNotes;
                });
            };

            const handleMoveNoteToSection = (noteId, sectionName) => {
                setNotes(prev => {
                    const newNotes = prev.map(n => n.id === noteId ? { ...n, section: sectionName } : n);
                    if (user) localStorage.setItem('faiora_notes_' + user.uid, JSON.stringify(newNotes));
                    return newNotes;
                });
                // Sync to Firestore
                if (user && activeCollection) {
                    db.collection(activeCollection).doc(user.uid).update({
                        [`notes.${noteId}.section`]: sectionName
                    }).catch(e => console.warn('Section move sync fail', e));
                }
                if (showToast) showToast('Moved to ' + (sectionName || 'All Notes'));
            };

            const handleOpenCreator = () => {
                setEditingNote(null);
                setIsCreatorOpen(true);
            };

            const handleEditNote = (note) => {
                setEditingNote(note);
                setIsCreatorOpen(true);
            };

            const handleCloseCreator = () => {
                setEditingNote(null);
                setIsCreatorOpen(false);
            };

            useEffect(() => {
                const unsubscribe = auth.onAuthStateChanged((u) => {
                    setUser(u);
                    setIsAuthChecked(true);

                    if (u) {
                        // PARALLEL PROBE: Check all potential collections at once for maximum speed
                        const probeCollections = ['tasks', 'users', 'userdata', 'notes'];
                        let failureCount = 0;
                        let hasResolved = false;
                        probeCollections.forEach(coll => {
                            db.collection(coll).doc(u.uid).get().then(doc => {
                                if (hasResolved) return;
                                console.log(`Firestore probe: Found working collection '${coll}'`);
                                setActiveCollection(coll);
                                hasResolved = true;

                                if (!doc.exists) {
                                    const sampleNote = { 
                                        id: 'note_welcome', 
                                        title: 'Welcome to Faiora', 
                                        labels: ['GETTING STARTED'], 
                                        noteIcon: 'auto_stories', 
                                        noteTheme: 'peach', 
                                        content: '<div>Welcome! This is your first note. Click to edit, or use the + button to create a new one.</div>' 
                                    };
                                    const notesMap = {
                                        [sampleNote.id]: { ...sampleNote, updatedAt: firebase.firestore.FieldValue.serverTimestamp() }
                                    };
                                    db.collection(coll).doc(u.uid).set({ notes: notesMap })
                                        .catch(err => console.warn(`Silent seed fail for '${coll}':`, err.message));
                                }
                            }).catch(err => {
                                failureCount++;
                                if (failureCount === probeCollections.length && !hasResolved) {
                                    console.warn("All Firestore probes blocked by permissions. Defaulting to 'tasks' (Local Cache mode).");
                                    setActiveCollection('tasks');
                                    hasResolved = true;
                                }
                                if (err.code !== 'permission-denied') {
                                    console.warn(`Probe catch for ${coll}:`, err.message);
                                }
                            });
                        });

                        localStorage.setItem('faiora_logged_in', 'true');
                    }
                });

                const authTimeout = setTimeout(() => {
                    setIsAuthChecked(true);
                }, 5000);

                return () => {
                    unsubscribe();
                    clearTimeout(authTimeout);
                };
            }, []);

            useEffect(() => {
                const timer = setTimeout(() => {
                    setIsTimerDone(true);
                }, 1000);
                return () => clearTimeout(timer);
            }, []);

            useEffect(() => {
                if (videoRef.current) {
                    videoRef.current.playbackRate = 1.5;
                }
            }, [user, isTimerDone, isAuthChecked]);

            const handleLoadingComplete = useCallback(() => {
                setIsTimerDone(true);
            }, []);

            if (!isTimerDone || !isAuthChecked) {
                return <LoadingPage onComplete={handleLoadingComplete} />;
            }

            if (!user) {
                return <LoginModal />;
            }

            return (
                <MemoryRouter>
                    <video 
                        ref={videoRef}
                        className="fire-bg-video"
                        autoPlay 
                        loop 
                        muted 
                        playsInline
                        src="fire_bg_video.mp4"
                    />
                    <TransitionManager>
                        <Route path="/" element={<DashboardPage user={user} notes={notes} onOpenCreator={handleOpenCreator} onEditNote={handleEditNote} onRestoreDefaults={handleRestoreDefaults} />} />
                        <Route path="/notes" element={<NotesPage user={user} notes={notes} onOpenCreator={handleOpenCreator} onEditNote={handleEditNote} noteSections={noteSections} onAddSection={handleAddSection} onDeleteSection={handleDeleteSection} onMoveNote={handleMoveNoteToSection} />} />
                        <Route path="/calendar" element={<CalendarPage user={user} notes={notes} onOpenCreator={handleOpenCreator} onEditNote={handleEditNote} />} />
                        <Route path="/stats" element={<StatsPage user={user} onOpenCreator={handleOpenCreator} />} />
                        <Route path="/streak" element={<StreakPage user={user} onOpenCreator={handleOpenCreator} />} />
                        <Route path="/clock" element={<ClockPage user={user} onOpenCreator={handleOpenCreator} />} />
                    </TransitionManager>
                    {isCreatorOpen && <TaskCreator onClose={handleCloseCreator} user={user} editingNote={editingNote} activeCollection={activeCollection} onUpdateNote={handleUpdateNoteLocal} onDeleteNote={handleDeleteNoteLocal} showToast={showToast} />}
                    <div className="toast-container">
                        {toasts.map(toast => (
                            <div key={toast.id} className="toast-pill">
                                <span className="material-symbols-outlined text-primary text-sm">check_circle</span>
                                {toast.message}
                            </div>
                        ))}
                    </div>
                </MemoryRouter>
            );
        };

        const container = document.getElementById('root');
        const root = createRoot(container);
        root.render(<App />);
    </script>
</body>
</html>